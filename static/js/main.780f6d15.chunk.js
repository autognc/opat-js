(this.webpackJsonpopat=this.webpackJsonpopat||[]).push([[0],{38:function(e,t,n){e.exports=n.p+"static/media/image_000.1d777ccf.png"},39:function(e,t,n){e.exports=n.p+"static/media/image_240.097c432e.png"},40:function(e,t,n){e.exports=n.p+"static/media/image_480.90688ae9.png"},41:function(e,t,n){e.exports=n.p+"static/media/cygnus.7bb66b61.glb"},42:function(e){e.exports=JSON.parse('{"image_000.png":{"fov_y":19.8},"image_240.png":{"fov_y":19.8},"image_480.png":{"fov_y":19.8}}')},48:function(e,t,n){e.exports=n(57)},52:function(e,t,n){},57:function(e,t,n){"use strict";n.r(t);var a=n(4),r=n(0),i=n.n(r),o=n(28),s=n.n(o),c=(n(52),n(29)),l=n(7),u=n(13),d=n(1),m=n(15),f=n(30),p=n(44),h=n(16),v=n(10),g=n(20),y={keybindings:{KeyW:"translateUp",KeyS:"translateDown",KeyA:"translateLeft",KeyD:"translateRight",KeyZ:"translateForward",KeyX:"translateBackward",ArrowDown:"rotateMinusZ",ArrowUp:"rotatePlusZ",ArrowLeft:"rotateMinusY",ArrowRight:"rotatePlusY",Slash:"rotateMinusX",Period:"rotatePlusX",ShiftLeft:"decreaseSpeed",Enter:"savePose"},opacity:.7,translate_speed:5,translate_speed_low:1,rotate_speed:20,rotate_speed_low:5,default_pose:{position:[0,0,50],rotation:[1,0,0,0]}},b=function(){function e(t,n){var r=this;Object(v.a)(this,e),this.ACTIONS=Object.fromEntries(Object.entries(y.keybindings).map((function(e){var t=Object(a.a)(e,2),n=t[0],i=t[1];return[n,r[i]?r[i].bind(r):i]}))),this.model=t,this.keyDownListener=this.handleKeyDown.bind(this),this.keyUpListener=this.handleKeyUp.bind(this),this.executingActions=new Set,this.translate_speed=y.translate_speed,this.rotate_speed=2*y.rotate_speed*Math.PI/180,this.setPose=n}return Object(g.a)(e,[{key:"register",value:function(){document.addEventListener("keydown",this.keyDownListener),document.addEventListener("keyup",this.keyUpListener)}},{key:"deregister",value:function(){document.removeEventListener("keydown",this.keyDownListener),document.removeEventListener("keyup",this.keyUpListener)}},{key:"handleKeyDown",value:function(e){if(this.ACTIONS[e.code]&&e.preventDefault(),!e.repeat)switch(this.ACTIONS[e.code]){case void 0:break;case"decreaseSpeed":this._decreaseSpeed();break;case"savePose":break;default:this.executingActions.add(this.ACTIONS[e.code])}}},{key:"handleKeyUp",value:function(e){switch(this.ACTIONS[e.code]&&e.preventDefault(),this.ACTIONS[e.code]){case void 0:break;case"decreaseSpeed":this._resetSpeed();break;case"savePose":this._recordPose(!0);break;default:this.executingActions.delete(this.ACTIONS[e.code]),this._recordPose(!1)}}},{key:"update",value:function(e){var t,n=Object(h.a)(this.executingActions);try{for(n.s();!(t=n.n()).done;){(0,t.value)(e)}}catch(a){n.e(a)}finally{n.f()}}},{key:"_recordPose",value:function(e){var t=this.model.quaternion,n=t.x,a=t.y,r=t.z,i=t.w;this.setPose({position:this.model.position.toArray(),rotation:[i,n,a,r]},e)}},{key:"_decreaseSpeed",value:function(){this.translate_speed=y.translate_speed_low,this.rotate_speed=2*y.rotate_speed_low*Math.PI/180}},{key:"_resetSpeed",value:function(){this.translate_speed=y.translate_speed,this.rotate_speed=2*y.rotate_speed*Math.PI/180}},{key:"translateUp",value:function(e){this.model.position.y-=this.translate_speed*e}},{key:"translateDown",value:function(e){this.model.position.y+=this.translate_speed*e}},{key:"translateLeft",value:function(e){this.model.position.x-=this.translate_speed*e}},{key:"translateRight",value:function(e){this.model.position.x+=this.translate_speed*e}},{key:"translateForward",value:function(e){this.model.position.z+=this.translate_speed*e}},{key:"translateBackward",value:function(e){this.model.position.z-=this.translate_speed*e}},{key:"rotatePlusZ",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,0,1),this.rotate_speed*e)}},{key:"rotateMinusZ",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,0,1),-this.rotate_speed*e)}},{key:"rotatePlusY",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,1,0),this.rotate_speed*e)}},{key:"rotateMinusY",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,1,0),-this.rotate_speed*e)}},{key:"rotatePlusX",value:function(e){this.model.rotateOnAxis(new d.Vector3(1,0,0),this.rotate_speed*e)}},{key:"rotateMinusX",value:function(e){this.model.rotateOnAxis(new d.Vector3(1,0,0),-this.rotate_speed*e)}}]),e}();function k(e){var t,n=e.model,r=e.fov,o=e.setPose,s=e.initialPose;console.log("renderer re-render");var c,m=Object(u.d)(),f=m.camera,p=m.gl,h=m.scene,v=i.a.useMemo((function(){return new b(n,o)}),[n,o]);if(i.a.useLayoutEffect((function(){return v.register(),function(){return v.deregister()}}),[v]),f.fov=r,f.up=new d.Vector3(0,-1,0),f.position.set(0,0,0),f.lookAt(0,0,100),f.updateProjectionMatrix(),s)c=s;else if(0===n.position.z)c={position:y.default_pose.position.slice(),rotation:y.default_pose.rotation.slice()};else{var g=n.quaternion,k=g.x,w=g.y,E=g.z,_=g.w;c={position:n.position.toArray(),rotation:[_,k,w,E]}}var O=Object(a.a)(c.rotation,4),P=O[0],j=O[1],S=O[2],x=O[3];(t=n.position).set.apply(t,Object(l.a)(c.position)),n.setRotationFromQuaternion(new d.Quaternion(j,S,x,P)),o(c,c===s);var A,I=i.a.useRef();return Object(u.c)((function(e,t){v.update(t),I.current.render()}),1),[i.a.createElement("primitive",{key:"object",object:n}),i.a.createElement("effectComposer",{key:"composer",ref:I,args:[p]},i.a.createElement("renderPass",{attachArray:"passes",scene:h,camera:f}),i.a.createElement("shaderPass",{attachArray:"passes",args:[(A=y.opacity,{uniforms:{tDiffuse:{value:null},opacity:{value:A}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tgl_FragColor = opacity * texel;","}"].join("\n")})]}))]}Object(u.b)({ShaderPass:m.a,RenderPass:f.a,EffectComposer:p.a});var w=i.a.memo((function(e){var t=e.model,n=e.fov,a=e.position,r=e.setPose,o=e.initialPose;return console.log("viewer re-render"),i.a.createElement(u.a,{style:Object(c.a)({position:"absolute"},a)},i.a.createElement("pointLight",{position:[0,0,0],intensity:1}),t?i.a.createElement(k,{model:t,fov:n,setPose:r,initialPose:o}):null)})),E=n(45),_=n(59),O=n(23);function P(e){var t=i.a.useRef(),n=e.children,a=e.label,r=e.disabled,o=Object(E.a)(e,["children","label","disabled"]);return[i.a.createElement("input",Object.assign({key:"input",type:"file",ref:t,style:{display:"none"}},o)),i.a.createElement("div",{key:"button",className:"OpenFileButton"},i.a.createElement("div",{className:"OpenFileButton-label"},a),i.a.createElement(_.a,{size:"sm",variant:"light",disabled:void 0!==r&&r,onClick:function(){return t.current.click()}},n))]}function j(e){var t=e.currentImageIndex,n=e.setCurrentImageIndex,r=e.images,o=e.setImages,s=e.model,c=e.setModel,l=e.setIntrinsics,u=e.currentPose,d=e.setPoses,m=e.poses,f=e.isPoseSaved,p=i.a.useState(""),h=Object(a.a)(p,2),v=h[0],g=h[1],y=i.a.useState(""),b=Object(a.a)(y,2),k=b[0],w=b[1],E=i.a.useState(null),j=Object(a.a)(E,2),S=j[0],x=j[1],A=i.a.useMemo((function(){return new O.a}),[]);return i.a.createElement("div",{className:"StatusBar"},u&&u.position&&u.rotation&&!S?i.a.createElement("div",{className:"pose ".concat(f?"saved":"")},i.a.createElement("div",null,"position: (".concat(u.position.map((function(e){return e.toFixed(2)})),")")),i.a.createElement("div",null,"rotation: (".concat(u.rotation.map((function(e){return e.toFixed(2)})),")"))):null,S?i.a.createElement("div",{className:"error"},S):null,i.a.createElement("div",null,r.length>0?r[t].name:null),i.a.createElement("div",null,i.a.createElement(P,{label:r.length?"".concat(r.length," images "):null,multiple:!0,accept:"image/*",onChange:function(e){e.target.files.length>0&&(n(0),o(e.target.files))}},"Load images")),i.a.createElement("div",null,i.a.createElement(P,{label:k,accept:".glb",onChange:function(e){e.target.files.length>0&&(w(e.target.files[0].name),function(e,t,n,a){t.arrayBuffer().then((function(t){try{e.parse(t,"",(function(e){n(e.scenes[0].children[0]),a(null)}))}catch(r){a("Error loading model. Please try again.")}}))}(A,e.target.files[0],c,x))}},"Load model")),i.a.createElement("div",null,i.a.createElement(P,{label:v,accept:".json",disabled:!(s&&r),onChange:function(e){e.target.files.length>0&&function(e,t,n,a,r){e.text().then((function(i){var o;try{o=JSON.parse(i)}catch(c){return void n("Error parsing intrinsics file. Please try again.")}var s=new Set(Array.from(r).map((function(e){return e.name})));Object.keys(o).every((function(e){return s.has(e)}))?Object.values(o).every((function(e){return"number"===typeof e.fov_y}))?(t(o),a(e.name),n(null)):n("Intrinsics file has incorrect format."):n("Intrinsics keys do not match image filenames.")}))}(e.target.files[0],l,x,g,r)}},"Load intrinsics")),i.a.createElement("div",null,i.a.createElement(P,{accept:".json",disabled:!(s&&r),onChange:function(e){e.target.files.length>0&&function(e,t,n,a){e.text().then((function(e){var r;try{r=JSON.parse(e)}catch(o){n("Error parsing poses file. Please try again.")}var i=new Set(Array.from(a).map((function(e){return e.name})));Object.keys(r).every((function(e){return i.has(e)}))?Object.values(r).every((function(e){return Array.isArray(e.position)&&Array.isArray(e.rotation)&&3===e.position.length&&4===e.rotation.length&&e.position.concat(e.rotation).every((function(e){return"number"===typeof e}))}))?(t(r),n(null)):n("Poses file has incorrect format."):n("Poses keys do not match image filenames.")}))}(e.target.files[0],d,x,r)}},"Load poses")),i.a.createElement("div",null,i.a.createElement(_.a,{size:"sm",variant:"light",disabled:0===Object.keys(m).length,onClick:function(){return function(e){if(0!==Object.keys(e).length){var t=document.createElement("a"),n=new Blob([JSON.stringify(e)],{type:"text/plain"});t.href=URL.createObjectURL(n),t.download="poses.json",t.click(),URL.revokeObjectURL(t.href)}}(m)}},"Download poses")))}var S=n(58);var x=i.a.memo((function(e){var t=e.images,n=e.currentImageIndex,a=e.setCurrentImageIndex;return i.a.createElement(S.a,{variant:"flush",className:"SideBar"},Array.from(t).map((function(e,t){return i.a.createElement(S.a.Item,{active:n===t,key:t,onClick:function(){return a(t)}},e.name)})))})),A=n(38),I=n.n(A),L=n(39),C=n.n(L),N=n(40),U=n.n(N),D=n(41),M=n.n(D),R=n(42),B=["image_000.png","image_240.png","image_480.png"];function K(e){var t=e.naturalHeight,n=e.naturalWidth,a=e.height,r=e.width,i=Math.min(a/t,r/n),o=t*i,s=n*i;return{height:o,width:s,left:(r-s)/2,top:(a-o)/2}}function z(){console.log("index re-render");var e=i.a.useState([]),t=Object(a.a)(e,2),n=t[0],r=t[1],o=i.a.useState(),s=Object(a.a)(o,2),c=s[0],l=s[1],u=i.a.useState(),d=Object(a.a)(u,2),m=d[0],f=d[1],p=i.a.useState(),h=Object(a.a)(p,2),v=h[0],g=h[1],y=i.a.useState({}),b=Object(a.a)(y,2),k=b[0],E=b[1],_=i.a.useState(),P=Object(a.a)(_,2),S=P[0],A=P[1],L=i.a.useState(0),N=Object(a.a)(L,2),D=N[0],z=N[1],V=i.a.useState(!1),F=Object(a.a)(V,2),T=F[0],J=F[1];i.a.useEffect((function(){return function(e,t,n){var r=Promise.all([I.a,C.a,U.a].map((function(e,t){return window.fetch(e).then((function(e){return e.blob()})).then((function(e){return e.name=B[t],e}))}))),i=new O.a,o=window.fetch(M.a).then((function(e){return e.arrayBuffer()})).then((function(e){return new Promise((function(t){return i.parse(e,"",(function(e){return t(e.scenes[0].children[0])}))}))}));Promise.all([r,o]).then((function(r){var i=Object(a.a)(r,2),o=i[0],s=i[1];e(o),n(s),t(R)}))}(r,l,f)}),[]);var X=i.a.useRef(),Z=i.a.useRef(),Y=i.a.useMemo((function(){return Z.current&&URL.revokeObjectURL(Z.current),Z.current=n.length>0?URL.createObjectURL(n[D]):void 0,Z.current}),[n,D]),q=i.a.useCallback((function(e){0===n.length||e.repeat||("PageDown"===e.code&&(e.preventDefault(),z((D+1)%n.length)),"PageUp"===e.code&&(e.preventDefault(),z((D-1+n.length)%n.length)))}),[n,D]);i.a.useEffect((function(){return document.addEventListener("keydown",q),function(){return document.removeEventListener("keydown",q)}}),[q]);var Q=i.a.useCallback((function(){X.current&&g(K(X.current))}),[]);i.a.useEffect((function(){return window.addEventListener("resize",Q),function(){return window.removeEventListener("resize",Q)}}),[Q]);var W=i.a.useCallback((function(e,t){A(e),0!==n.length&&(t?(k[n[D].name]?Object.assign(k[n[D].name],e):k[n[D].name]=e,J(!0)):J(!1))}),[k,n,D]);return i.a.createElement("div",{className:"main-wrapper"},i.a.createElement(j,{currentImageIndex:D,setCurrentImageIndex:z,images:n,setImages:r,model:m,setModel:f,setIntrinsics:l,currentPose:S,setPoses:E,poses:k,isPoseSaved:T}),i.a.createElement("div",{className:"body-wrapper"},i.a.createElement("div",{className:"Viewer-wrapper"},Y?i.a.createElement("img",{className:"background-image",alt:"",key:"img",ref:X,src:Y,onLoad:function(){g(K(X.current))}}):i.a.createElement("div",{className:"loading"},"Loading sample data..."),i.a.createElement(w,Object.assign({key:"viewer"},{fov:c&&n.length>0?c[n[D].name].fov_y:40,model:m,position:v,initialPose:n.length>0?k[n[D].name]:void 0,setPose:W}))),i.a.createElement(x,{images:n,currentImageIndex:D,setCurrentImageIndex:z})))}s.a.render(i.a.createElement(i.a.StrictMode,null,i.a.createElement(z,null)),document.getElementById("root"))}},[[48,1,2]]]);
//# sourceMappingURL=main.780f6d15.chunk.js.map