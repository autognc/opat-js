(this.webpackJsonpopat=this.webpackJsonpopat||[]).push([[0],{38:function(e,t,n){e.exports=n.p+"static/media/image_000.1d777ccf.png"},39:function(e,t,n){e.exports=n.p+"static/media/image_240.097c432e.png"},40:function(e,t,n){e.exports=n.p+"static/media/image_480.90688ae9.png"},41:function(e,t,n){e.exports=n.p+"static/media/cygnus.7bb66b61.glb"},42:function(e){e.exports=JSON.parse('{"image_000.png":{"fov_y":19.8},"image_240.png":{"fov_y":19.8},"image_480.png":{"fov_y":19.8}}')},48:function(e,t,n){e.exports=n(57)},52:function(e,t,n){},57:function(e,t,n){"use strict";n.r(t);var a=n(3),r=n(0),o=n.n(r),i=n(28),s=n.n(i),c=(n(52),n(29)),l=n(6),u=n(13),d=n(1),m=(new d.Quaternion).setFromRotationMatrix((new d.Matrix4).makeRotationX(Math.PI/2)),f=(new d.Quaternion).setFromRotationMatrix((new d.Matrix4).makeRotationX(-Math.PI/2));function p(e){var t=e.clone().multiply(f),n=t.x,a=t.y,r=t.z;return[t.w,n,a,r]}var h=n(15),v=n(30),y=n(44),g=n(16),b=n(10),w=n(20),k={keybindings:{KeyW:"translateUp",KeyS:"translateDown",KeyA:"translateLeft",KeyD:"translateRight",KeyZ:"translateForward",KeyX:"translateBackward",ArrowDown:"rotateMinusZ",ArrowUp:"rotatePlusZ",ArrowLeft:"rotateMinusY",ArrowRight:"rotatePlusY",Slash:"rotateMinusX",Period:"rotatePlusX",ShiftLeft:"decreaseSpeed",Enter:"savePose"},opacity:.7,translate_speed:5,translate_speed_low:1,rotate_speed:20,rotate_speed_low:5,default_pose:{position:[0,0,50],rotation:[1,0,0,0]}},E=function(){function e(t,n){var r=this;Object(b.a)(this,e),this.ACTIONS=Object.fromEntries(Object.entries(k.keybindings).map((function(e){var t=Object(a.a)(e,2),n=t[0],o=t[1];return[n,r[o]?r[o].bind(r):o]}))),this.model=t,this.keyDownListener=this.handleKeyDown.bind(this),this.keyUpListener=this.handleKeyUp.bind(this),this.executingActions=new Set,this.translate_speed=k.translate_speed,this.rotate_speed=2*k.rotate_speed*Math.PI/180,this.setPose=n}return Object(w.a)(e,[{key:"register",value:function(){document.addEventListener("keydown",this.keyDownListener),document.addEventListener("keyup",this.keyUpListener)}},{key:"deregister",value:function(){document.removeEventListener("keydown",this.keyDownListener),document.removeEventListener("keyup",this.keyUpListener)}},{key:"handleKeyDown",value:function(e){if(this.ACTIONS[e.code]&&e.preventDefault(),!e.repeat)switch(this.ACTIONS[e.code]){case void 0:break;case"decreaseSpeed":this._decreaseSpeed();break;case"savePose":break;default:this.executingActions.add(this.ACTIONS[e.code])}}},{key:"handleKeyUp",value:function(e){switch(this.ACTIONS[e.code]&&e.preventDefault(),this.ACTIONS[e.code]){case void 0:break;case"decreaseSpeed":this._resetSpeed();break;case"savePose":this._recordPose(!0);break;default:this.executingActions.delete(this.ACTIONS[e.code]),this._recordPose(!1)}}},{key:"update",value:function(e){var t,n=Object(g.a)(this.executingActions);try{for(n.s();!(t=n.n()).done;){(0,t.value)(e)}}catch(a){n.e(a)}finally{n.f()}}},{key:"_recordPose",value:function(e){this.setPose({position:this.model.position.toArray(),rotation:p(this.model.quaternion)},e)}},{key:"_decreaseSpeed",value:function(){this.translate_speed=k.translate_speed_low,this.rotate_speed=2*k.rotate_speed_low*Math.PI/180}},{key:"_resetSpeed",value:function(){this.translate_speed=k.translate_speed,this.rotate_speed=2*k.rotate_speed*Math.PI/180}},{key:"translateUp",value:function(e){this.model.position.y-=this.translate_speed*e}},{key:"translateDown",value:function(e){this.model.position.y+=this.translate_speed*e}},{key:"translateLeft",value:function(e){this.model.position.x-=this.translate_speed*e}},{key:"translateRight",value:function(e){this.model.position.x+=this.translate_speed*e}},{key:"translateForward",value:function(e){this.model.position.z+=this.translate_speed*e}},{key:"translateBackward",value:function(e){this.model.position.z-=this.translate_speed*e}},{key:"rotatePlusZ",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,0,1),this.rotate_speed*e)}},{key:"rotateMinusZ",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,0,1),-this.rotate_speed*e)}},{key:"rotatePlusY",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,1,0),this.rotate_speed*e)}},{key:"rotateMinusY",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,1,0),-this.rotate_speed*e)}},{key:"rotatePlusX",value:function(e){this.model.rotateOnAxis(new d.Vector3(1,0,0),this.rotate_speed*e)}},{key:"rotateMinusX",value:function(e){this.model.rotateOnAxis(new d.Vector3(1,0,0),-this.rotate_speed*e)}}]),e}();function O(e){var t,n=e.model,r=e.fov,i=e.setPose,s=e.initialPose;console.log("renderer re-render");var c,f=Object(u.d)(),h=f.camera,v=f.gl,y=f.scene,g=o.a.useMemo((function(){return new E(n,i)}),[n,i]);o.a.useLayoutEffect((function(){return g.register(),function(){return g.deregister()}}),[g]),h.fov=r,h.up=new d.Vector3(0,-1,0),h.position.set(0,0,0),h.lookAt(0,0,100),h.updateProjectionMatrix(),c=s||(0===n.position.z?{position:k.default_pose.position.slice(),rotation:k.default_pose.rotation.slice()}:{position:n.position.toArray(),rotation:p(n.quaternion)}),(t=n.position).set.apply(t,Object(l.a)(c.position)),n.setRotationFromQuaternion(function(e){var t=Object(a.a)(e,4),n=t[0],r=t[1],o=t[2],i=t[3];return new d.Quaternion(r,o,i,n).multiply(m)}(c.rotation)),i(c,c===s);var b,w=o.a.useRef();return Object(u.c)((function(e,t){g.update(t),w.current.render()}),1),[o.a.createElement("primitive",{key:"object",object:n}),o.a.createElement("effectComposer",{key:"composer",ref:w,args:[v]},o.a.createElement("renderPass",{attachArray:"passes",scene:y,camera:h}),o.a.createElement("shaderPass",{attachArray:"passes",args:[(b=k.opacity,{uniforms:{tDiffuse:{value:null},opacity:{value:b}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tgl_FragColor = opacity * texel;","}"].join("\n")})]}))]}Object(u.b)({ShaderPass:h.a,RenderPass:v.a,EffectComposer:y.a});var _=o.a.memo((function(e){var t=e.model,n=e.fov,a=e.position,r=e.setPose,i=e.initialPose;return console.log("viewer re-render"),o.a.createElement(u.a,{style:Object(c.a)({position:"absolute"},a)},o.a.createElement("pointLight",{position:[0,0,0],intensity:1}),t?o.a.createElement(O,{model:t,fov:n,setPose:r,initialPose:i}):null)})),P=n(45),j=n(59),x=n(23);function S(e){var t=o.a.useRef(),n=e.children,a=e.label,r=e.disabled,i=e.onChoose,s=Object(P.a)(e,["children","label","disabled","onChoose"]);return[o.a.createElement("input",Object.assign({key:"input",type:"file",ref:t,style:{display:"none"},onChange:function(e){i(Object(l.a)(e.target.files)),t.current.value=""}},s)),o.a.createElement("div",{key:"button",className:"OpenFileButton"},o.a.createElement("div",{className:"OpenFileButton-label"},a),o.a.createElement(j.a,{size:"sm",variant:"light",disabled:void 0!==r&&r,onClick:function(){return t.current.click()}},n))]}function A(e){var t=e.setCurrentImageIndex,n=e.images,r=e.fov,i=e.setImages,s=e.model,c=e.setModel,l=e.setIntrinsics,u=e.currentPose,m=e.setPoses,f=e.poses,p=e.isPoseSaved,h=o.a.useState(""),v=Object(a.a)(h,2),y=v[0],g=v[1],b=o.a.useState(""),w=Object(a.a)(b,2),k=w[0],E=w[1],O=o.a.useState(null),_=Object(a.a)(O,2),P=_[0],A=_[1],L=o.a.useMemo((function(){return new x.a}),[]),I=o.a.useMemo((function(){if(u&&u.rotation){var e=Object(a.a)(u.rotation,4),t=e[0],n=e[1],r=e[2],o=e[3],i=(new d.Euler).setFromQuaternion(new d.Quaternion(n,r,o,t),"ZYX");return[i.x,i.y,i.z]}}),[u]);return o.a.createElement("div",{className:"StatusBar"},u&&u.position&&I&&!P?o.a.createElement("div",{className:"pose ".concat(p?"saved":"")},o.a.createElement("div",null,"position: (".concat(u.position.map((function(e){return e.toFixed(2)})),")")),o.a.createElement("div",null,"rotation: (".concat(I.map((function(e){return(180*e/Math.PI).toFixed(2)})),")"))):null,P?o.a.createElement("div",{className:"error"},P):null,o.a.createElement("div",null,r?"fov: (".concat(r.x.toFixed(2),", ").concat(r.y.toFixed(2),")"):null),o.a.createElement("div",null,o.a.createElement(S,{label:n.length?"".concat(n.length," images "):null,multiple:!0,accept:"image/*",onChoose:function(e){e.length>0&&(t(0),i(e),l(void 0),m([]),A(null))}},"Load images")),o.a.createElement("div",null,o.a.createElement(S,{label:k,accept:".glb",onChoose:function(e){e.length>0&&(E(e[0].name),function(e,t,n,a){t.arrayBuffer().then((function(t){try{e.parse(t,"",(function(e){n(e.scenes[0].children[0]),a(null)}))}catch(r){a("Error loading model. Please try again.")}}))}(L,e[0],c,A))}},"Load model")),o.a.createElement("div",null,o.a.createElement(S,{label:y,accept:".json",disabled:!(s&&n),onChoose:function(e){e.length>0&&function(e,t,n,a,r){e.text().then((function(o){var i;try{i=JSON.parse(o)}catch(c){return void n("Error parsing intrinsics file. Please try again.")}var s=new Set(Object.keys(i));Array.from(r).every((function(e){return s.has(e.name)}))?Object.values(i).every((function(e){return"number"===typeof e.fov_y}))?(t(i),a(e.name),n(null)):n("Intrinsics file has incorrect format."):n("Missing entry in intrinsics file for image.")}))}(e[0],l,A,g,n)}},"Load intrinsics")),o.a.createElement("div",null,o.a.createElement(S,{accept:".json",disabled:!(s&&n),onChoose:function(e){e.length>0&&function(e,t,n,a){e.text().then((function(e){var r;try{r=JSON.parse(e)}catch(i){n("Error parsing poses file. Please try again.")}var o=new Set(Object.keys(r));Array.from(a).every((function(e){return o.has(e.name)}))?Object.values(r).every((function(e){return Array.isArray(e.position)&&Array.isArray(e.rotation)&&3===e.position.length&&4===e.rotation.length&&e.position.concat(e.rotation).every((function(e){return"number"===typeof e}))}))?(t(r),n(null)):n("Poses file has incorrect format."):n("Missing entry in poses file for image.")}))}(e[0],m,A,n)}},"Load poses")),o.a.createElement("div",null,o.a.createElement(j.a,{size:"sm",variant:"light",disabled:0===Object.keys(f).length,onClick:function(){return function(e){if(0!==Object.keys(e).length){var t=document.createElement("a"),n=new Blob([JSON.stringify(e)],{type:"text/plain"});t.href=URL.createObjectURL(n),t.download="poses.json",t.click(),URL.revokeObjectURL(t.href)}}(f)}},"Download poses")))}var L=n(58);var I=o.a.memo((function(e){var t=e.images,n=e.currentImageIndex,a=e.setCurrentImageIndex;return o.a.createElement(L.a,{variant:"flush",className:"SideBar"},Array.from(t).map((function(e,t){return o.a.createElement(L.a.Item,{active:n===t,key:t,onClick:function(){return a(t)}},e.name)})))})),M=n(38),C=n.n(M),N=n(39),R=n.n(N),U=n(40),D=n.n(U),F=n(41),B=n.n(F),K=n(42),z=["image_000.png","image_240.png","image_480.png"];function V(e){var t=e.naturalHeight,n=e.naturalWidth,a=e.height,r=e.width,o=Math.min(a/t,r/n),i=t*o,s=n*o;return{height:i,width:s,left:(r-s)/2,top:(a-i)/2}}function X(){console.log("index re-render");var e=o.a.useState([]),t=Object(a.a)(e,2),n=t[0],r=t[1],i=o.a.useState(),s=Object(a.a)(i,2),c=s[0],l=s[1],u=o.a.useState(),d=Object(a.a)(u,2),m=d[0],f=d[1],p=o.a.useState(),h=Object(a.a)(p,2),v=h[0],y=h[1],g=o.a.useState({}),b=Object(a.a)(g,2),w=b[0],k=b[1],E=o.a.useState(),O=Object(a.a)(E,2),P=O[0],j=O[1],S=o.a.useState(0),L=Object(a.a)(S,2),M=L[0],N=L[1],U=o.a.useState(!1),F=Object(a.a)(U,2),X=F[0],T=F[1];o.a.useEffect((function(){return function(e,t,n){var r=Promise.all([C.a,R.a,D.a].map((function(e,t){return window.fetch(e).then((function(e){return e.blob()})).then((function(e){return e.name=z[t],e}))}))),o=new x.a,i=window.fetch(B.a).then((function(e){return e.arrayBuffer()})).then((function(e){return new Promise((function(t){return o.parse(e,"",(function(e){return t(e.scenes[0].children[0])}))}))}));Promise.all([r,i]).then((function(r){var o=Object(a.a)(r,2),i=o[0],s=o[1];e(i),n(s),t(K)}))}(r,l,f)}),[]);var J=o.a.useRef(),Q=o.a.useRef(),Z=o.a.useMemo((function(){return Q.current&&URL.revokeObjectURL(Q.current),Q.current=n.length>0?URL.createObjectURL(n[M]):void 0,Q.current}),[n,M]),Y=o.a.useCallback((function(e){0===n.length||e.repeat||("PageDown"===e.code&&(e.preventDefault(),N((M+1)%n.length)),"PageUp"===e.code&&(e.preventDefault(),N((M-1+n.length)%n.length)))}),[n,M]);o.a.useEffect((function(){return document.addEventListener("keydown",Y),function(){return document.removeEventListener("keydown",Y)}}),[Y]);var q=o.a.useCallback((function(){J.current&&y(V(J.current))}),[]);o.a.useEffect((function(){return window.addEventListener("resize",q),function(){return window.removeEventListener("resize",q)}}),[q]);var W=o.a.useCallback((function(e,t){j(e),0!==n.length&&(t?(w[n[M].name]?Object.assign(w[n[M].name],e):w[n[M].name]=e,T(!0)):T(!1))}),[w,n,M]),H=c&&n.length>0?c[n[M].name].fov_y:40;return o.a.createElement("div",{className:"main-wrapper"},o.a.createElement(A,{fov:v?{y:H,x:H*v.width/v.height}:void 0,setCurrentImageIndex:N,images:n,setImages:r,model:m,setModel:f,setIntrinsics:l,currentPose:P,setPoses:k,poses:w,isPoseSaved:X}),o.a.createElement("div",{className:"body-wrapper"},o.a.createElement("div",{className:"Viewer-wrapper"},Z?o.a.createElement("img",{className:"background-image",alt:"",key:"img",ref:J,src:Z,onLoad:function(){y(V(J.current))}}):o.a.createElement("div",{className:"loading"},"Loading sample data..."),o.a.createElement(_,Object.assign({key:"viewer"},{fov:H,model:m,position:v,initialPose:n.length>0?w[n[M].name]:void 0,setPose:W}))),o.a.createElement(I,{images:n,currentImageIndex:M,setCurrentImageIndex:N})))}s.a.render(o.a.createElement(o.a.StrictMode,null,o.a.createElement(X,null)),document.getElementById("root"))}},[[48,1,2]]]);
//# sourceMappingURL=main.d003cebc.chunk.js.map