{"version":3,"sources":["sample_data/image_000.png","sample_data/image_240.png","sample_data/image_480.png","sample_data/cygnus.glb","utils.js","config.js","controls.js","viewer.js","OpacityShader.js","topbar.js","sidebar.js","sample_data/load_sample_data.js","index.js"],"names":["module","exports","ROTATE_FORWARD","Quaternion","setFromRotationMatrix","Matrix4","makeRotationX","Math","PI","ROTATE_BACKWARD","encodeRotation","quaternion","clone","multiply","x","y","z","w","CONFIG","keybindings","KeyW","KeyS","KeyA","KeyD","KeyZ","KeyX","ArrowDown","ArrowUp","ArrowLeft","ArrowRight","Slash","Period","ShiftLeft","Enter","opacity","translate_speed","translate_speed_low","rotate_speed","rotate_speed_low","default_pose","position","rotation","Controls","model","setPose","ACTIONS","Object","fromEntries","entries","map","key","value","bind","this","keyDownListener","handleKeyDown","keyUpListener","handleKeyUp","executingActions","Set","document","addEventListener","removeEventListener","event","code","preventDefault","repeat","undefined","_decreaseSpeed","add","_resetSpeed","_recordPose","delete","delta","action","save","toArray","rotateOnAxis","Vector3","Renderer","fov","initialPose","console","log","pose","useThree","camera","gl","scene","controls","React","useMemo","useLayoutEffect","register","deregister","up","set","lookAt","updateProjectionMatrix","slice","setRotationFromQuaternion","quatArray","decodeRotation","composer","useRef","useFrame","state","update","current","render","object","ref","args","attachArray","uniforms","tDiffuse","vertexShader","join","fragmentShader","extend","ShaderPass","RenderPass","EffectComposer","memo","style","intensity","OpenFileButton","props","children","label","disabled","onChoose","others","type","display","onChange","target","files","className","Button","size","variant","onClick","click","TopBar","setCurrentImageIndex","currentImageIndex","images","setImages","setModel","setIntrinsics","currentPose","setPoses","poses","useState","intrinsicsName","setIntrinsicsName","modelName","setModelName","error","setError","loader","GLTFLoader","Euler","setFromQuaternion","isPoseSaved","equal","name","n","toFixed","length","multiple","accept","file","arrayBuffer","then","ab","parse","gltf","scenes","loadModel","text","resultText","intrinsics","JSON","keys","Array","from","every","i","has","values","fov_y","loadIntrinsics","p","isArray","concat","e","loadPoses","obj","a","createElement","Blob","stringify","href","URL","createObjectURL","download","revokeObjectURL","saveAs","ListGroup","image","Item","active","IMAGE_NAMES","computeViewerPosition","img","naturalHeight","naturalWidth","height","width","rescale","min","newHeight","newWidth","left","top","App","viewerPosition","setViewerPosition","setCurrentPose","useEffect","imagesPromise","Promise","all","image_000","image_240","image_480","window","fetch","res","blob","modelPromise","cygnus","resolve","loadSampleData","imgRef","imgUrlRef","imgUrl","useCallback","newImageIndex","handleResize","assign","alt","src","onLoad","ReactDOM","StrictMode","getElementById"],"mappings":"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","file":"static/js/main.0dcafec4.chunk.js","sourcesContent":["module.exports = __webpack_public_path__ + \"static/media/image_000.1d777ccf.png\";","module.exports = __webpack_public_path__ + \"static/media/image_240.097c432e.png\";","module.exports = __webpack_public_path__ + \"static/media/image_480.90688ae9.png\";","module.exports = __webpack_public_path__ + \"static/media/cygnus.7bb66b61.glb\";","import { Quaternion, Matrix4 } from \"three\";\n\nconst ROTATE_FORWARD = new Quaternion().setFromRotationMatrix(\n  new Matrix4().makeRotationX(Math.PI / 2)\n);\nconst ROTATE_BACKWARD = new Quaternion().setFromRotationMatrix(\n  new Matrix4().makeRotationX(-Math.PI / 2)\n);\n\nexport function encodeRotation(quaternion) {\n  const { x, y, z, w } = quaternion.clone().multiply(ROTATE_BACKWARD);\n  return [w, x, y, z];\n}\n\nexport function decodeRotation(quatArray) {\n  const [w, x, y, z] = quatArray;\n  return new Quaternion(x, y, z, w).multiply(ROTATE_FORWARD);\n}\n","const CONFIG = {\n  keybindings: {\n    KeyW: \"translateUp\",\n    KeyS: \"translateDown\",\n    KeyA: \"translateLeft\",\n    KeyD: \"translateRight\",\n    KeyZ: \"translateForward\",\n    KeyX: \"translateBackward\",\n    ArrowDown: \"rotateMinusZ\",\n    ArrowUp: \"rotatePlusZ\",\n    ArrowLeft: \"rotateMinusY\",\n    ArrowRight: \"rotatePlusY\",\n    Slash: \"rotateMinusX\",\n    Period: \"rotatePlusX\",\n    ShiftLeft: \"decreaseSpeed\",\n    Enter: \"savePose\",\n  },\n  opacity: 0.7,\n  // meters/second\n  translate_speed: 5,\n  translate_speed_low: 0.5,\n  // degrees/second\n  rotate_speed: 20,\n  rotate_speed_low: 2,\n  default_pose: {\n    position: [0, 0, 50],\n    rotation: [1, 0, 0, 0],\n  },\n};\n\nexport default CONFIG;\n","import { Vector3 } from \"three\";\nimport CONFIG from \"./config\";\nimport { encodeRotation } from \"./utils\";\n\nexport default class Controls {\n  ACTIONS = Object.fromEntries(\n    Object.entries(CONFIG.keybindings).map(([key, value]) => [\n      key,\n      this[value] ? this[value].bind(this) : value,\n    ])\n  );\n\n  constructor(model, setPose) {\n    this.model = model;\n    this.keyDownListener = this.handleKeyDown.bind(this);\n    this.keyUpListener = this.handleKeyUp.bind(this);\n    this.executingActions = new Set();\n    this.translate_speed = CONFIG.translate_speed;\n    this.rotate_speed = (CONFIG.rotate_speed * 2 * Math.PI) / 180;\n    this.setPose = setPose;\n  }\n\n  register() {\n    document.addEventListener(\"keydown\", this.keyDownListener);\n    document.addEventListener(\"keyup\", this.keyUpListener);\n  }\n\n  deregister() {\n    document.removeEventListener(\"keydown\", this.keyDownListener);\n    document.removeEventListener(\"keyup\", this.keyUpListener);\n  }\n\n  handleKeyDown(event) {\n    if (this.ACTIONS[event.code]) event.preventDefault();\n    if (event.repeat) return;\n    switch (this.ACTIONS[event.code]) {\n      case undefined:\n        break;\n      case \"decreaseSpeed\":\n        this._decreaseSpeed();\n        break;\n      case \"savePose\":\n        break;\n      default:\n        this.executingActions.add(this.ACTIONS[event.code]);\n    }\n  }\n\n  handleKeyUp(event) {\n    if (this.ACTIONS[event.code]) event.preventDefault();\n    switch (this.ACTIONS[event.code]) {\n      case undefined:\n        break;\n      case \"decreaseSpeed\":\n        this._resetSpeed();\n        break;\n      case \"savePose\":\n        this._recordPose(true);\n        break;\n      default:\n        this.executingActions.delete(this.ACTIONS[event.code]);\n        this._recordPose(false);\n    }\n  }\n\n  update(delta) {\n    for (const action of this.executingActions) {\n      action(delta);\n    }\n  }\n\n  _recordPose(save) {\n    this.setPose(\n      {\n        position: this.model.position.toArray(),\n        rotation: encodeRotation(this.model.quaternion),\n      },\n      save\n    );\n  }\n\n  _decreaseSpeed() {\n    this.translate_speed = CONFIG.translate_speed_low;\n    this.rotate_speed = (CONFIG.rotate_speed_low * 2 * Math.PI) / 180;\n  }\n  _resetSpeed() {\n    this.translate_speed = CONFIG.translate_speed;\n    this.rotate_speed = (CONFIG.rotate_speed * 2 * Math.PI) / 180;\n  }\n\n  translateUp(delta) {\n    this.model.position.y -= this.translate_speed * delta;\n  }\n  translateDown(delta) {\n    this.model.position.y += this.translate_speed * delta;\n  }\n  translateLeft(delta) {\n    this.model.position.x -= this.translate_speed * delta;\n  }\n  translateRight(delta) {\n    this.model.position.x += this.translate_speed * delta;\n  }\n  translateForward(delta) {\n    this.model.position.z += this.translate_speed * delta;\n  }\n  translateBackward(delta) {\n    this.model.position.z -= this.translate_speed * delta;\n  }\n  rotatePlusZ(delta) {\n    this.model.rotateOnAxis(new Vector3(0, 0, 1), this.rotate_speed * delta);\n  }\n  rotateMinusZ(delta) {\n    this.model.rotateOnAxis(new Vector3(0, 0, 1), -this.rotate_speed * delta);\n  }\n  rotatePlusY(delta) {\n    this.model.rotateOnAxis(new Vector3(0, 1, 0), this.rotate_speed * delta);\n  }\n  rotateMinusY(delta) {\n    this.model.rotateOnAxis(new Vector3(0, 1, 0), -this.rotate_speed * delta);\n  }\n  rotatePlusX(delta) {\n    this.model.rotateOnAxis(new Vector3(1, 0, 0), this.rotate_speed * delta);\n  }\n  rotateMinusX(delta) {\n    this.model.rotateOnAxis(new Vector3(1, 0, 0), -this.rotate_speed * delta);\n  }\n}\n","import React from \"react\";\nimport { extend } from \"react-three-fiber\";\nimport { Canvas, useFrame, useThree } from \"react-three-fiber\";\nimport { Vector3 } from \"three\";\nimport { encodeRotation, decodeRotation } from \"./utils\";\nimport { ShaderPass } from \"three/examples/jsm/postprocessing/ShaderPass\";\nimport { RenderPass } from \"three/examples/jsm/postprocessing/RenderPass\";\nimport { EffectComposer } from \"three/examples/jsm/postprocessing/EffectComposer\";\nimport Controls from \"./controls\";\nimport CONFIG from \"./config\";\nimport OpacityShader from \"./OpacityShader\";\nextend({ ShaderPass, RenderPass, EffectComposer });\n\nfunction Renderer({ model, fov, setPose, initialPose }) {\n  console.log(\"renderer re-render\");\n  const { camera, gl, scene } = useThree();\n\n  const controls = React.useMemo(() => new Controls(model, setPose), [\n    model,\n    setPose,\n  ]);\n  // Need useLayoutEffect because we want the controls to deregister ASAP (before render) whenever\n  // the image changes. With regular useEffect, which happens after render, there is a brief window of time\n  // between when the model's pose gets updated for the new image and when the old controls get de-registered.\n  // Since the old controls have the old setPose, they can set the new image's pose on the old image during this window.\n  React.useLayoutEffect(() => {\n    controls.register();\n    return () => controls.deregister();\n  }, [controls]);\n\n  camera.fov = fov;\n  camera.up = new Vector3(0, -1, 0);\n  camera.position.set(0, 0, 0);\n  camera.lookAt(0, 0, 100);\n  camera.updateProjectionMatrix();\n\n  let pose;\n  if (initialPose) {\n    pose = initialPose;\n  } else if (model.position.z === 0) {\n    pose = {\n      position: CONFIG.default_pose.position.slice(),\n      rotation: CONFIG.default_pose.rotation.slice(),\n    };\n  } else {\n    pose = {\n      position: model.position.toArray(),\n      rotation: encodeRotation(model.quaternion),\n    };\n  }\n  model.position.set(...pose.position);\n  model.setRotationFromQuaternion(decodeRotation(pose.rotation));\n  setPose(pose, false);\n\n  const composer = React.useRef();\n  useFrame((state, delta) => {\n    controls.update(delta);\n    composer.current.render();\n  }, 1);\n\n  return [\n    <primitive key=\"object\" object={model} />,\n    <effectComposer key=\"composer\" ref={composer} args={[gl]}>\n      <renderPass attachArray=\"passes\" scene={scene} camera={camera} />\n      <shaderPass attachArray=\"passes\" args={[OpacityShader(CONFIG.opacity)]} />\n    </effectComposer>,\n  ];\n}\n\nfunction Viewer({ model, fov, position, setPose, initialPose }) {\n  console.log(\"viewer re-render\");\n\n  return (\n    <Canvas style={{ position: \"absolute\", ...position }}>\n      <pointLight position={[0, 0, 0]} intensity={1} />\n      {model ? <Renderer {...{ model, fov, setPose, initialPose }} /> : null}\n    </Canvas>\n  );\n}\n\nexport default React.memo(Viewer);\n","/**\n * Full-screen textured quad shader\n */\n\nexport default function OpacityShader(opacity) {\n  return {\n    uniforms: {\n      tDiffuse: { value: null },\n      opacity: { value: opacity },\n    },\n\n    vertexShader: [\n      \"varying vec2 vUv;\",\n\n      \"void main() {\",\n\n      \"\tvUv = uv;\",\n      \"\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\",\n\n      \"}\",\n    ].join(\"\\n\"),\n\n    fragmentShader: [\n      \"uniform float opacity;\",\n\n      \"uniform sampler2D tDiffuse;\",\n\n      \"varying vec2 vUv;\",\n\n      \"void main() {\",\n\n      \"\tvec4 texel = texture2D( tDiffuse, vUv );\",\n      \"\tgl_FragColor = opacity * texel;\",\n\n      \"}\",\n    ].join(\"\\n\"),\n  };\n}\n","import React from \"react\";\nimport { Button } from \"react-bootstrap\";\nimport { GLTFLoader } from \"three/examples/jsm/loaders/GLTFLoader\";\nimport { Euler, Quaternion } from \"three\";\nimport * as equal from \"fast-deep-equal\";\n\nfunction saveAs(obj) {\n  if (Object.keys(obj).length === 0) {\n    return;\n  }\n  const a = document.createElement(\"a\");\n  const file = new Blob([JSON.stringify(obj)], { type: \"text/plain\" });\n  a.href = URL.createObjectURL(file);\n  a.download = \"poses.json\";\n  a.click();\n  URL.revokeObjectURL(a.href);\n}\n\nfunction loadModel(loader, file, setModel, setError) {\n  file.arrayBuffer().then((ab) => {\n    try {\n      loader.parse(ab, \"\", (gltf) => {\n        setModel(gltf.scenes[0].children[0]);\n        setError(null);\n      });\n    } catch {\n      setError(\"Error loading model. Please try again.\");\n    }\n  });\n}\n\nfunction loadIntrinsics(\n  file,\n  setIntrinsics,\n  setError,\n  setIntrinsicsName,\n  images\n) {\n  file.text().then((resultText) => {\n    let intrinsics;\n    try {\n      intrinsics = JSON.parse(resultText);\n    } catch {\n      setError(\"Error parsing intrinsics file. Please try again.\");\n      return;\n    }\n    const keys = new Set(Object.keys(intrinsics));\n    if (!Array.from(images).every((i) => keys.has(i.name))) {\n      setError(\"Missing entry in intrinsics file for image.\");\n      return;\n    }\n    if (!Object.values(intrinsics).every((i) => typeof i.fov_y === \"number\")) {\n      setError(\"Intrinsics file has incorrect format.\");\n      return;\n    }\n    setIntrinsics(intrinsics);\n    setIntrinsicsName(file.name);\n    setError(null);\n  });\n}\n\nfunction loadPoses(file, setPoses, setError, images) {\n  file.text().then((resultText) => {\n    let poses;\n    try {\n      poses = JSON.parse(resultText);\n    } catch {\n      setError(\"Error parsing poses file. Please try again.\");\n    }\n    if (\n      !Object.values(poses).every(\n        (p) =>\n          Array.isArray(p.position) &&\n          Array.isArray(p.rotation) &&\n          p.position.length === 3 &&\n          p.rotation.length === 4 &&\n          p.position.concat(p.rotation).every((e) => typeof e === \"number\")\n      )\n    ) {\n      setError(\"Poses file has incorrect format.\");\n      return;\n    }\n    setPoses(poses);\n    setError(null);\n  });\n}\n\nfunction OpenFileButton(props) {\n  const ref = React.useRef();\n  const { children, label, disabled, onChoose, ...others } = props;\n  return [\n    <input\n      key=\"input\"\n      type=\"file\"\n      ref={ref}\n      style={{ display: \"none\" }}\n      onChange={(event) => {\n        onChoose([...event.target.files]);\n        ref.current.value = \"\";\n      }}\n      {...others}\n    />,\n    <div key=\"button\" className=\"OpenFileButton\">\n      <div className=\"OpenFileButton-label\">{label}</div>\n      <Button\n        size=\"sm\"\n        variant=\"light\"\n        disabled={disabled === undefined ? false : disabled}\n        onClick={() => ref.current.click()}\n      >\n        {children}\n      </Button>\n    </div>,\n  ];\n}\n\nexport default function TopBar({\n  setCurrentImageIndex,\n  currentImageIndex,\n  images,\n  fov,\n  setImages,\n  model,\n  setModel,\n  setIntrinsics,\n  currentPose,\n  setPoses,\n  poses,\n}) {\n  const [intrinsicsName, setIntrinsicsName] = React.useState(\"\");\n  const [modelName, setModelName] = React.useState(\"\");\n  const [error, setError] = React.useState(null);\n  const loader = React.useMemo(() => new GLTFLoader(), []);\n\n  const rotation = React.useMemo(() => {\n    if (currentPose && currentPose.rotation) {\n      const [w, x, y, z] = currentPose.rotation;\n      const { x: ex, y: ey, z: ez } = new Euler().setFromQuaternion(\n        new Quaternion(x, y, z, w),\n        \"ZYX\"\n      );\n      return [ex, ey, ez];\n    } else {\n      return undefined;\n    }\n  }, [currentPose]);\n\n  const isPoseSaved = React.useMemo(\n    () =>\n      currentPose && currentPose.position && rotation\n        ? equal(currentPose, poses[images[currentImageIndex].name])\n        : false,\n    [poses, currentPose, currentImageIndex, images, rotation]\n  );\n\n  return (\n    <div className=\"StatusBar\">\n      {currentPose && currentPose.position && rotation && !error ? (\n        <div className={`pose ${isPoseSaved ? \"saved\" : \"\"}`}>\n          <div>{`position: (${currentPose.position.map((n) =>\n            n.toFixed(2)\n          )})`}</div>\n          <div>{`rotation: (${rotation.map((n) =>\n            ((n * 180) / Math.PI).toFixed(2)\n          )})`}</div>\n        </div>\n      ) : null}\n      {error ? <div className=\"error\">{error}</div> : null}\n      <div>\n        {fov ? `fov: (${fov.x.toFixed(2)}, ${fov.y.toFixed(2)})` : null}\n      </div>\n      <div>\n        <OpenFileButton\n          label={images.length ? `${images.length} images ` : null}\n          multiple\n          accept=\"image/*\"\n          onChoose={(files) => {\n            if (files.length > 0) {\n              setCurrentImageIndex(0);\n              setImages(files);\n              setIntrinsics(undefined);\n              setPoses({});\n              setError(null);\n            }\n          }}\n        >\n          Load images\n        </OpenFileButton>\n      </div>\n      <div>\n        <OpenFileButton\n          label={modelName}\n          accept=\".glb\"\n          onChoose={(files) => {\n            if (files.length > 0) {\n              setModelName(files[0].name);\n              loadModel(loader, files[0], setModel, setError);\n            }\n          }}\n        >\n          Load model\n        </OpenFileButton>\n      </div>\n      <div>\n        <OpenFileButton\n          label={intrinsicsName}\n          accept=\".json\"\n          disabled={!(model && images)}\n          onChoose={(files) => {\n            if (files.length > 0) {\n              loadIntrinsics(\n                files[0],\n                setIntrinsics,\n                setError,\n                setIntrinsicsName,\n                images\n              );\n            }\n          }}\n        >\n          Load intrinsics\n        </OpenFileButton>\n      </div>\n      <div>\n        <OpenFileButton\n          accept=\".json\"\n          disabled={!(model && images)}\n          onChoose={(files) => {\n            if (files.length > 0) {\n              loadPoses(files[0], setPoses, setError, images);\n            }\n          }}\n        >\n          Load poses\n        </OpenFileButton>\n      </div>\n      <div>\n        <Button\n          size=\"sm\"\n          variant=\"light\"\n          disabled={Object.keys(poses).length === 0}\n          onClick={() => saveAs(poses)}\n        >\n          Download poses\n        </Button>\n      </div>\n    </div>\n  );\n}\n","import React from \"react\";\nimport { ListGroup } from \"react-bootstrap\";\n\nfunction Sidebar({ images, currentImageIndex, setCurrentImageIndex }) {\n  return (\n    <ListGroup variant=\"flush\" className=\"SideBar\">\n      {Array.from(images).map((image, i) => (\n        <ListGroup.Item\n          active={currentImageIndex === i}\n          key={i}\n          onClick={() => setCurrentImageIndex(i)}\n        >\n          {image.name}\n        </ListGroup.Item>\n      ))}\n    </ListGroup>\n  );\n}\n\nexport default React.memo(Sidebar);\n","import image_000 from \"./image_000.png\";\nimport image_240 from \"./image_240.png\";\nimport image_480 from \"./image_480.png\";\nimport cygnus from \"./cygnus.glb\";\nimport intrinsics from \"./intrinsics.json\";\nimport { GLTFLoader } from \"three/examples/jsm/loaders/GLTFLoader\";\nconst IMAGE_NAMES = [\"image_000.png\", \"image_240.png\", \"image_480.png\"];\n\nexport default function loadSampleData(setImages, setIntrinsics, setModel) {\n  const imagesPromise = Promise.all(\n    [image_000, image_240, image_480].map((image, i) =>\n      window\n        .fetch(image)\n        .then((res) => res.blob())\n        .then((blob) => {\n          blob.name = IMAGE_NAMES[i];\n          return blob;\n        })\n    )\n  );\n  const loader = new GLTFLoader();\n  const modelPromise = window\n    .fetch(cygnus)\n    .then((res) => res.arrayBuffer())\n    .then(\n      (ab) =>\n        new Promise((resolve) =>\n          loader.parse(ab, \"\", (gltf) => resolve(gltf.scenes[0].children[0]))\n        )\n    );\n\n  Promise.all([imagesPromise, modelPromise]).then(([images, model]) => {\n    setImages(images);\n    setModel(model);\n    setIntrinsics(intrinsics);\n  });\n}\n","import React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport \"./index.css\";\nimport Viewer from \"./viewer\";\nimport TopBar from \"./topbar\";\nimport Sidebar from \"./sidebar\";\nimport loadSampleData from \"./sample_data/load_sample_data\";\n\nfunction computeViewerPosition(img) {\n  const { naturalHeight, naturalWidth, height, width } = img;\n  const rescale = Math.min(height / naturalHeight, width / naturalWidth);\n  const [newHeight, newWidth] = [\n    naturalHeight * rescale,\n    naturalWidth * rescale,\n  ];\n  return {\n    height: newHeight,\n    width: newWidth,\n    left: (width - newWidth) / 2,\n    top: (height - newHeight) / 2,\n  };\n}\n\nfunction App() {\n  console.log(\"index re-render\");\n\n  const [images, setImages] = React.useState([]);\n  const [intrinsics, setIntrinsics] = React.useState();\n  const [model, setModel] = React.useState();\n  const [viewerPosition, setViewerPosition] = React.useState();\n  const [poses, setPoses] = React.useState({});\n  const [currentPose, setCurrentPose] = React.useState();\n  const [currentImageIndex, setCurrentImageIndex] = React.useState(0);\n\n  React.useEffect(() => loadSampleData(setImages, setIntrinsics, setModel), []);\n\n  const imgRef = React.useRef();\n  const imgUrlRef = React.useRef();\n  const imgUrl = React.useMemo(() => {\n    if (imgUrlRef.current) URL.revokeObjectURL(imgUrlRef.current);\n    imgUrlRef.current =\n      images.length > 0\n        ? URL.createObjectURL(images[currentImageIndex])\n        : undefined;\n    return imgUrlRef.current;\n  }, [images, currentImageIndex]);\n\n  const handleKeyDown = React.useCallback(\n    (event) => {\n      if (\n        images.length === 0 ||\n        event.repeat ||\n        !(event.code === \"PageDown\" || event.code === \"PageUp\")\n      )\n        return;\n\n      event.preventDefault();\n      const newImageIndex =\n        event.code === \"PageDown\"\n          ? (currentImageIndex + 1) % images.length\n          : (currentImageIndex - 1 + images.length) % images.length; // Javascript is a cruel joke\n      setCurrentImageIndex(newImageIndex);\n    },\n    [images, currentImageIndex]\n  );\n  React.useEffect(() => {\n    document.addEventListener(\"keydown\", handleKeyDown);\n    return () => document.removeEventListener(\"keydown\", handleKeyDown);\n  }, [handleKeyDown]);\n\n  const handleResize = React.useCallback(() => {\n    if (imgRef.current)\n      setViewerPosition(computeViewerPosition(imgRef.current));\n  }, []);\n  React.useEffect(() => {\n    window.addEventListener(\"resize\", handleResize);\n    return () => window.removeEventListener(\"resize\", handleResize);\n  }, [handleResize]);\n\n  const setPose = React.useCallback(\n    (pose, save) => {\n      // cause the topbar to re-render\n      setCurrentPose(pose);\n\n      if (images.length === 0) return;\n\n      if (save) {\n        if (poses[images[currentImageIndex].name]) {\n          // copy into the same reference so that the viewer doesn't re-render\n          Object.assign(poses[images[currentImageIndex].name], pose);\n        } else {\n          poses[images[currentImageIndex].name] = pose;\n        }\n        setCurrentImageIndex((currentImageIndex + 1) % images.length);\n      }\n    },\n    [poses, images, currentImageIndex]\n  );\n\n  const fov =\n    intrinsics && images.length > 0\n      ? intrinsics[images[currentImageIndex].name].fov_y\n      : 40;\n\n  return (\n    <div className=\"main-wrapper\">\n      <TopBar\n        {...{\n          fov: viewerPosition\n            ? {\n                y: fov,\n                x: (fov * viewerPosition.width) / viewerPosition.height,\n              }\n            : undefined,\n          setCurrentImageIndex,\n          images,\n          setImages,\n          model,\n          setModel,\n          setIntrinsics,\n          currentPose,\n          setPoses,\n          poses,\n          currentImageIndex,\n        }}\n      />\n      <div className=\"body-wrapper\">\n        <div className=\"Viewer-wrapper\">\n          {imgUrl ? (\n            <img\n              className=\"background-image\"\n              alt=\"\"\n              key=\"img\"\n              ref={imgRef}\n              src={imgUrl}\n              onLoad={() => {\n                setViewerPosition(computeViewerPosition(imgRef.current));\n              }}\n            />\n          ) : (\n            <div className=\"loading\">Loading sample data...</div>\n          )}\n          <Viewer\n            key=\"viewer\"\n            {...{\n              fov,\n              model,\n              position: viewerPosition,\n              initialPose:\n                images.length > 0\n                  ? poses[images[currentImageIndex].name]\n                  : undefined,\n              setPose,\n            }}\n          />\n        </div>\n        <Sidebar\n          {...{\n            images,\n            currentImageIndex,\n            setCurrentImageIndex,\n          }}\n        />\n      </div>\n    </div>\n  );\n}\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n);\n"],"sourceRoot":""}