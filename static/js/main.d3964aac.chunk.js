(this.webpackJsonpopat=this.webpackJsonpopat||[]).push([[0],{38:function(e,t,n){e.exports=n.p+"static/media/image_000.1d777ccf.png"},39:function(e,t,n){e.exports=n.p+"static/media/image_240.097c432e.png"},40:function(e,t,n){e.exports=n.p+"static/media/image_480.90688ae9.png"},41:function(e,t,n){e.exports=n.p+"static/media/cygnus.7bb66b61.glb"},42:function(e){e.exports=JSON.parse('{"image_000.png":{"fov_y":19.8},"image_240.png":{"fov_y":19.8},"image_480.png":{"fov_y":19.8}}')},48:function(e,t,n){e.exports=n(57)},52:function(e,t,n){},57:function(e,t,n){"use strict";n.r(t);var a=n(4),r=n(0),i=n.n(r),o=n(28),s=n.n(o),c=(n(52),n(29)),l=n(6),u=n(13),d=n(1),f=n(15),m=n(30),p=n(44),h=n(16),v=n(10),y=n(20),g={keybindings:{KeyW:"translateUp",KeyS:"translateDown",KeyA:"translateLeft",KeyD:"translateRight",KeyZ:"translateForward",KeyX:"translateBackward",ArrowDown:"rotateMinusZ",ArrowUp:"rotatePlusZ",ArrowLeft:"rotateMinusY",ArrowRight:"rotatePlusY",Slash:"rotateMinusX",Period:"rotatePlusX",ShiftLeft:"decreaseSpeed",Enter:"savePose"},opacity:.7,translate_speed:5,translate_speed_low:1,rotate_speed:20,rotate_speed_low:5,default_pose:{position:[0,0,50],rotation:[1,0,0,0]}},b=function(){function e(t,n){var r=this;Object(v.a)(this,e),this.ACTIONS=Object.fromEntries(Object.entries(g.keybindings).map((function(e){var t=Object(a.a)(e,2),n=t[0],i=t[1];return[n,r[i]?r[i].bind(r):i]}))),this.model=t,this.keyDownListener=this.handleKeyDown.bind(this),this.keyUpListener=this.handleKeyUp.bind(this),this.executingActions=new Set,this.translate_speed=g.translate_speed,this.rotate_speed=2*g.rotate_speed*Math.PI/180,this.setPose=n}return Object(y.a)(e,[{key:"register",value:function(){document.addEventListener("keydown",this.keyDownListener),document.addEventListener("keyup",this.keyUpListener)}},{key:"deregister",value:function(){document.removeEventListener("keydown",this.keyDownListener),document.removeEventListener("keyup",this.keyUpListener)}},{key:"handleKeyDown",value:function(e){if(this.ACTIONS[e.code]&&e.preventDefault(),!e.repeat)switch(this.ACTIONS[e.code]){case void 0:break;case"decreaseSpeed":this._decreaseSpeed();break;case"savePose":break;default:this.executingActions.add(this.ACTIONS[e.code])}}},{key:"handleKeyUp",value:function(e){switch(this.ACTIONS[e.code]&&e.preventDefault(),this.ACTIONS[e.code]){case void 0:break;case"decreaseSpeed":this._resetSpeed();break;case"savePose":this._recordPose(!0);break;default:this.executingActions.delete(this.ACTIONS[e.code]),this._recordPose(!1)}}},{key:"update",value:function(e){var t,n=Object(h.a)(this.executingActions);try{for(n.s();!(t=n.n()).done;){(0,t.value)(e)}}catch(a){n.e(a)}finally{n.f()}}},{key:"_recordPose",value:function(e){var t=this.model.quaternion,n=t.x,a=t.y,r=t.z,i=t.w;this.setPose({position:this.model.position.toArray(),rotation:[i,n,a,r]},e)}},{key:"_decreaseSpeed",value:function(){this.translate_speed=g.translate_speed_low,this.rotate_speed=2*g.rotate_speed_low*Math.PI/180}},{key:"_resetSpeed",value:function(){this.translate_speed=g.translate_speed,this.rotate_speed=2*g.rotate_speed*Math.PI/180}},{key:"translateUp",value:function(e){this.model.position.y-=this.translate_speed*e}},{key:"translateDown",value:function(e){this.model.position.y+=this.translate_speed*e}},{key:"translateLeft",value:function(e){this.model.position.x-=this.translate_speed*e}},{key:"translateRight",value:function(e){this.model.position.x+=this.translate_speed*e}},{key:"translateForward",value:function(e){this.model.position.z+=this.translate_speed*e}},{key:"translateBackward",value:function(e){this.model.position.z-=this.translate_speed*e}},{key:"rotatePlusZ",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,0,1),this.rotate_speed*e)}},{key:"rotateMinusZ",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,0,1),-this.rotate_speed*e)}},{key:"rotatePlusY",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,1,0),this.rotate_speed*e)}},{key:"rotateMinusY",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,1,0),-this.rotate_speed*e)}},{key:"rotatePlusX",value:function(e){this.model.rotateOnAxis(new d.Vector3(1,0,0),this.rotate_speed*e)}},{key:"rotateMinusX",value:function(e){this.model.rotateOnAxis(new d.Vector3(1,0,0),-this.rotate_speed*e)}}]),e}();function k(e){var t,n=e.model,r=e.fov,o=e.setPose,s=e.initialPose;console.log("renderer re-render");var c,f=Object(u.d)(),m=f.camera,p=f.gl,h=f.scene,v=i.a.useMemo((function(){return new b(n,o)}),[n,o]);if(i.a.useLayoutEffect((function(){return v.register(),function(){return v.deregister()}}),[v]),m.fov=r,m.up=new d.Vector3(0,-1,0),m.position.set(0,0,0),m.lookAt(0,0,100),m.updateProjectionMatrix(),s)c=s;else if(0===n.position.z)c={position:g.default_pose.position.slice(),rotation:g.default_pose.rotation.slice()};else{var y=n.quaternion,k=y.x,w=y.y,E=y.z,O=y.w;c={position:n.position.toArray(),rotation:[O,k,w,E]}}var _=Object(a.a)(c.rotation,4),j=_[0],P=_[1],x=_[2],S=_[3];(t=n.position).set.apply(t,Object(l.a)(c.position)),n.setRotationFromQuaternion(new d.Quaternion(P,x,S,j)),o(c,c===s);var A,L=i.a.useRef();return Object(u.c)((function(e,t){v.update(t),L.current.render()}),1),[i.a.createElement("primitive",{key:"object",object:n}),i.a.createElement("effectComposer",{key:"composer",ref:L,args:[p]},i.a.createElement("renderPass",{attachArray:"passes",scene:h,camera:m}),i.a.createElement("shaderPass",{attachArray:"passes",args:[(A=g.opacity,{uniforms:{tDiffuse:{value:null},opacity:{value:A}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tgl_FragColor = opacity * texel;","}"].join("\n")})]}))]}Object(u.b)({ShaderPass:f.a,RenderPass:m.a,EffectComposer:p.a});var w=i.a.memo((function(e){var t=e.model,n=e.fov,a=e.position,r=e.setPose,o=e.initialPose;return console.log("viewer re-render"),i.a.createElement(u.a,{style:Object(c.a)({position:"absolute"},a)},i.a.createElement("pointLight",{position:[0,0,0],intensity:1}),t?i.a.createElement(k,{model:t,fov:n,setPose:r,initialPose:o}):null)})),E=n(45),O=n(59),_=n(23);function j(e){var t=i.a.useRef(),n=e.children,a=e.label,r=e.disabled,o=e.onChoose,s=Object(E.a)(e,["children","label","disabled","onChoose"]);return[i.a.createElement("input",Object.assign({key:"input",type:"file",ref:t,style:{display:"none"},onChange:function(e){o(Object(l.a)(e.target.files)),t.current.value=""}},s)),i.a.createElement("div",{key:"button",className:"OpenFileButton"},i.a.createElement("div",{className:"OpenFileButton-label"},a),i.a.createElement(O.a,{size:"sm",variant:"light",disabled:void 0!==r&&r,onClick:function(){return t.current.click()}},n))]}function P(e){var t=e.setCurrentImageIndex,n=e.images,r=e.fov,o=e.setImages,s=e.model,c=e.setModel,l=e.setIntrinsics,u=e.currentPose,d=e.setPoses,f=e.poses,m=e.isPoseSaved,p=i.a.useState(""),h=Object(a.a)(p,2),v=h[0],y=h[1],g=i.a.useState(""),b=Object(a.a)(g,2),k=b[0],w=b[1],E=i.a.useState(null),P=Object(a.a)(E,2),x=P[0],S=P[1],A=i.a.useMemo((function(){return new _.a}),[]);return i.a.createElement("div",{className:"StatusBar"},u&&u.position&&u.rotation&&!x?i.a.createElement("div",{className:"pose ".concat(m?"saved":"")},i.a.createElement("div",null,"position: (".concat(u.position.map((function(e){return e.toFixed(2)})),")")),i.a.createElement("div",null,"rotation: (".concat(u.rotation.map((function(e){return e.toFixed(2)})),")"))):null,x?i.a.createElement("div",{className:"error"},x):null,i.a.createElement("div",null,r?"fov: (".concat(r.x.toFixed(2),", ").concat(r.y.toFixed(2),")"):null),i.a.createElement("div",null,i.a.createElement(j,{label:n.length?"".concat(n.length," images "):null,multiple:!0,accept:"image/*",onChoose:function(e){e.length>0&&(t(0),o(e),l(void 0),d([]),S(null))}},"Load images")),i.a.createElement("div",null,i.a.createElement(j,{label:k,accept:".glb",onChoose:function(e){e.length>0&&(w(e[0].name),function(e,t,n,a){t.arrayBuffer().then((function(t){try{e.parse(t,"",(function(e){n(e.scenes[0].children[0]),a(null)}))}catch(r){a("Error loading model. Please try again.")}}))}(A,e[0],c,S))}},"Load model")),i.a.createElement("div",null,i.a.createElement(j,{label:v,accept:".json",disabled:!(s&&n),onChoose:function(e){e.length>0&&function(e,t,n,a,r){e.text().then((function(i){var o;try{o=JSON.parse(i)}catch(c){return void n("Error parsing intrinsics file. Please try again.")}var s=new Set(Object.keys(o));Array.from(r).every((function(e){return s.has(e.name)}))?Object.values(o).every((function(e){return"number"===typeof e.fov_y}))?(t(o),a(e.name),n(null)):n("Intrinsics file has incorrect format."):n("Missing entry in intrinsics file for image.")}))}(e[0],l,S,y,n)}},"Load intrinsics")),i.a.createElement("div",null,i.a.createElement(j,{accept:".json",disabled:!(s&&n),onChoose:function(e){e.length>0&&function(e,t,n,a){e.text().then((function(e){var r;try{r=JSON.parse(e)}catch(o){n("Error parsing poses file. Please try again.")}var i=new Set(Object.keys(r));Array.from(a).every((function(e){return i.has(e.name)}))?Object.values(r).every((function(e){return Array.isArray(e.position)&&Array.isArray(e.rotation)&&3===e.position.length&&4===e.rotation.length&&e.position.concat(e.rotation).every((function(e){return"number"===typeof e}))}))?(t(r),n(null)):n("Poses file has incorrect format."):n("Missing entry in poses file for image.")}))}(e[0],d,S,n)}},"Load poses")),i.a.createElement("div",null,i.a.createElement(O.a,{size:"sm",variant:"light",disabled:0===Object.keys(f).length,onClick:function(){return function(e){if(0!==Object.keys(e).length){var t=document.createElement("a"),n=new Blob([JSON.stringify(e)],{type:"text/plain"});t.href=URL.createObjectURL(n),t.download="poses.json",t.click(),URL.revokeObjectURL(t.href)}}(f)}},"Download poses")))}var x=n(58);var S=i.a.memo((function(e){var t=e.images,n=e.currentImageIndex,a=e.setCurrentImageIndex;return i.a.createElement(x.a,{variant:"flush",className:"SideBar"},Array.from(t).map((function(e,t){return i.a.createElement(x.a.Item,{active:n===t,key:t,onClick:function(){return a(t)}},e.name)})))})),A=n(38),L=n.n(A),I=n(39),C=n.n(I),N=n(40),M=n.n(N),U=n(41),D=n.n(U),R=n(42),B=["image_000.png","image_240.png","image_480.png"];function F(e){var t=e.naturalHeight,n=e.naturalWidth,a=e.height,r=e.width,i=Math.min(a/t,r/n),o=t*i,s=n*i;return{height:o,width:s,left:(r-s)/2,top:(a-o)/2}}function K(){console.log("index re-render");var e=i.a.useState([]),t=Object(a.a)(e,2),n=t[0],r=t[1],o=i.a.useState(),s=Object(a.a)(o,2),c=s[0],l=s[1],u=i.a.useState(),d=Object(a.a)(u,2),f=d[0],m=d[1],p=i.a.useState(),h=Object(a.a)(p,2),v=h[0],y=h[1],g=i.a.useState({}),b=Object(a.a)(g,2),k=b[0],E=b[1],O=i.a.useState(),j=Object(a.a)(O,2),x=j[0],A=j[1],I=i.a.useState(0),N=Object(a.a)(I,2),U=N[0],K=N[1],z=i.a.useState(!1),V=Object(a.a)(z,2),T=V[0],J=V[1];i.a.useEffect((function(){return function(e,t,n){var r=Promise.all([L.a,C.a,M.a].map((function(e,t){return window.fetch(e).then((function(e){return e.blob()})).then((function(e){return e.name=B[t],e}))}))),i=new _.a,o=window.fetch(D.a).then((function(e){return e.arrayBuffer()})).then((function(e){return new Promise((function(t){return i.parse(e,"",(function(e){return t(e.scenes[0].children[0])}))}))}));Promise.all([r,o]).then((function(r){var i=Object(a.a)(r,2),o=i[0],s=i[1];e(o),n(s),t(R)}))}(r,l,m)}),[]);var X=i.a.useRef(),Z=i.a.useRef(),Y=i.a.useMemo((function(){return Z.current&&URL.revokeObjectURL(Z.current),Z.current=n.length>0?URL.createObjectURL(n[U]):void 0,Z.current}),[n,U]),q=i.a.useCallback((function(e){0===n.length||e.repeat||("PageDown"===e.code&&(e.preventDefault(),K((U+1)%n.length)),"PageUp"===e.code&&(e.preventDefault(),K((U-1+n.length)%n.length)))}),[n,U]);i.a.useEffect((function(){return document.addEventListener("keydown",q),function(){return document.removeEventListener("keydown",q)}}),[q]);var Q=i.a.useCallback((function(){X.current&&y(F(X.current))}),[]);i.a.useEffect((function(){return window.addEventListener("resize",Q),function(){return window.removeEventListener("resize",Q)}}),[Q]);var W=i.a.useCallback((function(e,t){A(e),0!==n.length&&(t?(k[n[U].name]?Object.assign(k[n[U].name],e):k[n[U].name]=e,J(!0)):J(!1))}),[k,n,U]),H=c&&n.length>0?c[n[U].name].fov_y:40;return i.a.createElement("div",{className:"main-wrapper"},i.a.createElement(P,{fov:v?{y:H,x:H*v.width/v.height}:void 0,setCurrentImageIndex:K,images:n,setImages:r,model:f,setModel:m,setIntrinsics:l,currentPose:x,setPoses:E,poses:k,isPoseSaved:T}),i.a.createElement("div",{className:"body-wrapper"},i.a.createElement("div",{className:"Viewer-wrapper"},Y?i.a.createElement("img",{className:"background-image",alt:"",key:"img",ref:X,src:Y,onLoad:function(){y(F(X.current))}}):i.a.createElement("div",{className:"loading"},"Loading sample data..."),i.a.createElement(w,Object.assign({key:"viewer"},{fov:H,model:f,position:v,initialPose:n.length>0?k[n[U].name]:void 0,setPose:W}))),i.a.createElement(S,{images:n,currentImageIndex:U,setCurrentImageIndex:K})))}s.a.render(i.a.createElement(i.a.StrictMode,null,i.a.createElement(K,null)),document.getElementById("root"))}},[[48,1,2]]]);
//# sourceMappingURL=main.d3964aac.chunk.js.map