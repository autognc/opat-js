(this.webpackJsonpopat=this.webpackJsonpopat||[]).push([[0],{39:function(e,t,n){e.exports=n.p+"static/media/image_000.1d777ccf.png"},40:function(e,t,n){e.exports=n.p+"static/media/image_240.097c432e.png"},41:function(e,t,n){e.exports=n.p+"static/media/image_480.90688ae9.png"},42:function(e,t,n){e.exports=n.p+"static/media/cygnus.7bb66b61.glb"},43:function(e){e.exports=JSON.parse('{"image_000.png":{"fov_y":19.8},"image_240.png":{"fov_y":19.8},"image_480.png":{"fov_y":19.8}}')},49:function(e,t,n){e.exports=n(58)},53:function(e,t,n){},58:function(e,t,n){"use strict";n.r(t);var a=n(4),r=n(0),o=n.n(r),i=n(28),s=n.n(i),c=(n(53),n(29)),l=n(6),u=n(13),d=n(1),m=(new d.Quaternion).setFromRotationMatrix((new d.Matrix4).makeRotationX(Math.PI/2)),f=(new d.Quaternion).setFromRotationMatrix((new d.Matrix4).makeRotationX(-Math.PI/2));function p(e){var t=e.clone().multiply(f),n=t.x,a=t.y,r=t.z;return[t.w,n,a,r]}var h=n(15),v=n(30),g=n(45),y=n(16),b=n(10),w=n(20),k={keybindings:{KeyW:"translateUp",KeyS:"translateDown",KeyA:"translateLeft",KeyD:"translateRight",KeyZ:"translateForward",KeyX:"translateBackward",ArrowDown:"rotateMinusZ",ArrowUp:"rotatePlusZ",ArrowLeft:"rotateMinusY",ArrowRight:"rotatePlusY",Slash:"rotateMinusX",Period:"rotatePlusX",ShiftLeft:"decreaseSpeed",Enter:"savePose"},opacity:.7,translate_speed:5,translate_speed_low:1,rotate_speed:20,rotate_speed_low:5,default_pose:{position:[0,0,50],rotation:[1,0,0,0]}},E=function(){function e(t,n){var r=this;Object(b.a)(this,e),this.ACTIONS=Object.fromEntries(Object.entries(k.keybindings).map((function(e){var t=Object(a.a)(e,2),n=t[0],o=t[1];return[n,r[o]?r[o].bind(r):o]}))),this.model=t,this.keyDownListener=this.handleKeyDown.bind(this),this.keyUpListener=this.handleKeyUp.bind(this),this.executingActions=new Set,this.translate_speed=k.translate_speed,this.rotate_speed=2*k.rotate_speed*Math.PI/180,this.setPose=n}return Object(w.a)(e,[{key:"register",value:function(){document.addEventListener("keydown",this.keyDownListener),document.addEventListener("keyup",this.keyUpListener)}},{key:"deregister",value:function(){document.removeEventListener("keydown",this.keyDownListener),document.removeEventListener("keyup",this.keyUpListener)}},{key:"handleKeyDown",value:function(e){if(this.ACTIONS[e.code]&&e.preventDefault(),!e.repeat)switch(this.ACTIONS[e.code]){case void 0:break;case"decreaseSpeed":this._decreaseSpeed();break;case"savePose":break;default:this.executingActions.add(this.ACTIONS[e.code])}}},{key:"handleKeyUp",value:function(e){switch(this.ACTIONS[e.code]&&e.preventDefault(),this.ACTIONS[e.code]){case void 0:break;case"decreaseSpeed":this._resetSpeed();break;case"savePose":this._recordPose(!0);break;default:this.executingActions.delete(this.ACTIONS[e.code]),this._recordPose(!1)}}},{key:"update",value:function(e){var t,n=Object(y.a)(this.executingActions);try{for(n.s();!(t=n.n()).done;){(0,t.value)(e)}}catch(a){n.e(a)}finally{n.f()}}},{key:"_recordPose",value:function(e){this.setPose({position:this.model.position.toArray(),rotation:p(this.model.quaternion)},e)}},{key:"_decreaseSpeed",value:function(){this.translate_speed=k.translate_speed_low,this.rotate_speed=2*k.rotate_speed_low*Math.PI/180}},{key:"_resetSpeed",value:function(){this.translate_speed=k.translate_speed,this.rotate_speed=2*k.rotate_speed*Math.PI/180}},{key:"translateUp",value:function(e){this.model.position.y-=this.translate_speed*e}},{key:"translateDown",value:function(e){this.model.position.y+=this.translate_speed*e}},{key:"translateLeft",value:function(e){this.model.position.x-=this.translate_speed*e}},{key:"translateRight",value:function(e){this.model.position.x+=this.translate_speed*e}},{key:"translateForward",value:function(e){this.model.position.z+=this.translate_speed*e}},{key:"translateBackward",value:function(e){this.model.position.z-=this.translate_speed*e}},{key:"rotatePlusZ",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,0,1),this.rotate_speed*e)}},{key:"rotateMinusZ",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,0,1),-this.rotate_speed*e)}},{key:"rotatePlusY",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,1,0),this.rotate_speed*e)}},{key:"rotateMinusY",value:function(e){this.model.rotateOnAxis(new d.Vector3(0,1,0),-this.rotate_speed*e)}},{key:"rotatePlusX",value:function(e){this.model.rotateOnAxis(new d.Vector3(1,0,0),this.rotate_speed*e)}},{key:"rotateMinusX",value:function(e){this.model.rotateOnAxis(new d.Vector3(1,0,0),-this.rotate_speed*e)}}]),e}();function _(e){var t,n=e.model,r=e.fov,i=e.setPose,s=e.initialPose;console.log("renderer re-render");var c,f=Object(u.d)(),h=f.camera,v=f.gl,g=f.scene,y=o.a.useMemo((function(){return new E(n,i)}),[n,i]);o.a.useLayoutEffect((function(){return y.register(),function(){return y.deregister()}}),[y]),h.fov=r,h.up=new d.Vector3(0,-1,0),h.position.set(0,0,0),h.lookAt(0,0,100),h.updateProjectionMatrix(),c=s||(0===n.position.z?{position:k.default_pose.position.slice(),rotation:k.default_pose.rotation.slice()}:{position:n.position.toArray(),rotation:p(n.quaternion)}),(t=n.position).set.apply(t,Object(l.a)(c.position)),n.setRotationFromQuaternion(function(e){var t=Object(a.a)(e,4),n=t[0],r=t[1],o=t[2],i=t[3];return new d.Quaternion(r,o,i,n).multiply(m)}(c.rotation)),i(c,!1);var b,w=o.a.useRef();return Object(u.c)((function(e,t){y.update(t),w.current.render()}),1),[o.a.createElement("primitive",{key:"object",object:n}),o.a.createElement("effectComposer",{key:"composer",ref:w,args:[v]},o.a.createElement("renderPass",{attachArray:"passes",scene:g,camera:h}),o.a.createElement("shaderPass",{attachArray:"passes",args:[(b=k.opacity,{uniforms:{tDiffuse:{value:null},opacity:{value:b}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tgl_FragColor = opacity * texel;","}"].join("\n")})]}))]}Object(u.b)({ShaderPass:h.a,RenderPass:v.a,EffectComposer:g.a});var O=o.a.memo((function(e){var t=e.model,n=e.fov,a=e.position,r=e.setPose,i=e.initialPose;return console.log("viewer re-render"),o.a.createElement(u.a,{style:Object(c.a)({position:"absolute"},a)},o.a.createElement("pointLight",{position:[0,0,0],intensity:1}),t?o.a.createElement(_,{model:t,fov:n,setPose:r,initialPose:i}):null)})),x=n(46),P=n(60),j=n(23),S=n(35);function I(e){var t=o.a.useRef(),n=e.children,a=e.label,r=e.disabled,i=e.onChoose,s=Object(x.a)(e,["children","label","disabled","onChoose"]);return[o.a.createElement("input",Object.assign({key:"input",type:"file",ref:t,style:{display:"none"},onChange:function(e){i(Object(l.a)(e.target.files)),t.current.value=""}},s)),o.a.createElement("div",{key:"button",className:"OpenFileButton"},o.a.createElement("div",{className:"OpenFileButton-label"},a),o.a.createElement(P.a,{size:"sm",variant:"light",disabled:void 0!==r&&r,onClick:function(){return t.current.click()}},n))]}function L(e){var t=e.setCurrentImageIndex,n=e.currentImageIndex,r=e.images,i=e.fov,s=e.setImages,c=e.model,l=e.setModel,u=e.setIntrinsics,m=e.currentPose,f=e.setPoses,p=e.poses,h=o.a.useState(""),v=Object(a.a)(h,2),g=v[0],y=v[1],b=o.a.useState(""),w=Object(a.a)(b,2),k=w[0],E=w[1],_=o.a.useState(null),O=Object(a.a)(_,2),x=O[0],L=O[1],A=o.a.useMemo((function(){return new j.a}),[]),M=o.a.useMemo((function(){if(m&&m.rotation){var e=Object(a.a)(m.rotation,4),t=e[0],n=e[1],r=e[2],o=e[3],i=(new d.Euler).setFromQuaternion(new d.Quaternion(n,r,o,t),"ZYX");return[i.x,i.y,i.z]}}),[m]),C=o.a.useMemo((function(){return!!(m&&m.position&&M)&&S(m,p[r[n].name])}),[p,m,n,r,M]);return o.a.createElement("div",{className:"StatusBar"},m&&m.position&&M&&!x?o.a.createElement("div",{className:"pose ".concat(C?"saved":"")},o.a.createElement("div",null,"position: (".concat(m.position.map((function(e){return e.toFixed(2)})),")")),o.a.createElement("div",null,"rotation: (".concat(M.map((function(e){return(180*e/Math.PI).toFixed(2)})),")"))):null,x?o.a.createElement("div",{className:"error"},x):null,o.a.createElement("div",null,i?"fov: (".concat(i.x.toFixed(2),", ").concat(i.y.toFixed(2),")"):null),o.a.createElement("div",null,o.a.createElement(I,{label:r.length?"".concat(r.length," images "):null,multiple:!0,accept:"image/*",onChoose:function(e){e.length>0&&(t(0),s(e),u(void 0),f([]),L(null))}},"Load images")),o.a.createElement("div",null,o.a.createElement(I,{label:k,accept:".glb",onChoose:function(e){e.length>0&&(E(e[0].name),function(e,t,n,a){t.arrayBuffer().then((function(t){try{e.parse(t,"",(function(e){n(e.scenes[0].children[0]),a(null)}))}catch(r){a("Error loading model. Please try again.")}}))}(A,e[0],l,L))}},"Load model")),o.a.createElement("div",null,o.a.createElement(I,{label:g,accept:".json",disabled:!(c&&r),onChoose:function(e){e.length>0&&function(e,t,n,a,r){e.text().then((function(o){var i;try{i=JSON.parse(o)}catch(c){return void n("Error parsing intrinsics file. Please try again.")}var s=new Set(Object.keys(i));Array.from(r).every((function(e){return s.has(e.name)}))?Object.values(i).every((function(e){return"number"===typeof e.fov_y}))?(t(i),a(e.name),n(null)):n("Intrinsics file has incorrect format."):n("Missing entry in intrinsics file for image.")}))}(e[0],u,L,y,r)}},"Load intrinsics")),o.a.createElement("div",null,o.a.createElement(I,{accept:".json",disabled:!(c&&r),onChoose:function(e){e.length>0&&function(e,t,n,a){e.text().then((function(e){var a;try{a=JSON.parse(e)}catch(r){n("Error parsing poses file. Please try again.")}Object.values(a).every((function(e){return Array.isArray(e.position)&&Array.isArray(e.rotation)&&3===e.position.length&&4===e.rotation.length&&e.position.concat(e.rotation).every((function(e){return"number"===typeof e}))}))?(t(a),n(null)):n("Poses file has incorrect format.")}))}(e[0],f,L)}},"Load poses")),o.a.createElement("div",null,o.a.createElement(P.a,{size:"sm",variant:"light",disabled:0===Object.keys(p).length,onClick:function(){return function(e){if(0!==Object.keys(e).length){var t=document.createElement("a"),n=new Blob([JSON.stringify(e)],{type:"text/plain"});t.href=URL.createObjectURL(n),t.download="poses.json",t.click(),URL.revokeObjectURL(t.href)}}(p)}},"Download poses")))}var A=n(59);var M=o.a.memo((function(e){var t=e.images,n=e.currentImageIndex,a=e.setCurrentImageIndex;return o.a.createElement(A.a,{variant:"flush",className:"SideBar"},Array.from(t).map((function(e,t){return o.a.createElement(A.a.Item,{active:n===t,key:t,onClick:function(){return a(t)}},e.name)})))})),C=n(39),N=n.n(C),R=n(40),U=n.n(R),D=n(41),F=n.n(D),B=n(42),K=n.n(B),z=n(43),V=["image_000.png","image_240.png","image_480.png"];function X(e){var t=e.naturalHeight,n=e.naturalWidth,a=e.height,r=e.width,o=Math.min(a/t,r/n),i=t*o,s=n*o;return{height:i,width:s,left:(r-s)/2,top:(a-i)/2}}function T(){console.log("index re-render");var e=o.a.useState([]),t=Object(a.a)(e,2),n=t[0],r=t[1],i=o.a.useState(),s=Object(a.a)(i,2),c=s[0],l=s[1],u=o.a.useState(),d=Object(a.a)(u,2),m=d[0],f=d[1],p=o.a.useState(),h=Object(a.a)(p,2),v=h[0],g=h[1],y=o.a.useState({}),b=Object(a.a)(y,2),w=b[0],k=b[1],E=o.a.useState(),_=Object(a.a)(E,2),x=_[0],P=_[1],S=o.a.useState(0),I=Object(a.a)(S,2),A=I[0],C=I[1];o.a.useEffect((function(){return function(e,t,n){var r=Promise.all([N.a,U.a,F.a].map((function(e,t){return window.fetch(e).then((function(e){return e.blob()})).then((function(e){return e.name=V[t],e}))}))),o=new j.a,i=window.fetch(K.a).then((function(e){return e.arrayBuffer()})).then((function(e){return new Promise((function(t){return o.parse(e,"",(function(e){return t(e.scenes[0].children[0])}))}))}));Promise.all([r,i]).then((function(r){var o=Object(a.a)(r,2),i=o[0],s=o[1];e(i),n(s),t(z)}))}(r,l,f)}),[]);var R=o.a.useRef(),D=o.a.useRef(),B=o.a.useMemo((function(){return D.current&&URL.revokeObjectURL(D.current),D.current=n.length>0?URL.createObjectURL(n[A]):void 0,D.current}),[n,A]),T=o.a.useCallback((function(e){if(!(0===n.length||e.repeat||"PageDown"!==e.code&&"PageUp"!==e.code)){e.preventDefault();var t="PageDown"===e.code?(A+1)%n.length:(A-1+n.length)%n.length;C(t)}}),[n,A]);o.a.useEffect((function(){return document.addEventListener("keydown",T),function(){return document.removeEventListener("keydown",T)}}),[T]);var J=o.a.useCallback((function(){R.current&&g(X(R.current))}),[]);o.a.useEffect((function(){return window.addEventListener("resize",J),function(){return window.removeEventListener("resize",J)}}),[J]);var Q=o.a.useCallback((function(e,t){P(e),0!==n.length&&t&&(w[n[A].name]?Object.assign(w[n[A].name],e):w[n[A].name]=e,C((A+1)%n.length))}),[w,n,A]),Z=c&&n.length>0?c[n[A].name].fov_y:40;return o.a.createElement("div",{className:"main-wrapper"},o.a.createElement(L,{fov:v?{y:Z,x:Z*v.width/v.height}:void 0,setCurrentImageIndex:C,images:n,setImages:r,model:m,setModel:f,setIntrinsics:l,currentPose:x,setPoses:k,poses:w,currentImageIndex:A}),o.a.createElement("div",{className:"body-wrapper"},o.a.createElement("div",{className:"Viewer-wrapper"},B?o.a.createElement("img",{className:"background-image",alt:"",key:"img",ref:R,src:B,onLoad:function(){g(X(R.current))}}):o.a.createElement("div",{className:"loading"},"Loading sample data..."),o.a.createElement(O,Object.assign({key:"viewer"},{fov:Z,model:m,position:v,initialPose:n.length>0?w[n[A].name]:void 0,setPose:Q}))),o.a.createElement(M,{images:n,currentImageIndex:A,setCurrentImageIndex:C})))}s.a.render(o.a.createElement(o.a.StrictMode,null,o.a.createElement(T,null)),document.getElementById("root"))}},[[49,1,2]]]);
//# sourceMappingURL=main.17cebccf.chunk.js.map