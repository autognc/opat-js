{"version":3,"sources":["config.js","controls.js","viewer.js","OpacityShader.js","topbar.js","sidebar.js","index.js"],"names":["CONFIG","keybindings","KeyW","KeyS","KeyA","KeyD","KeyZ","KeyX","ArrowDown","ArrowUp","ArrowLeft","ArrowRight","Slash","Period","ShiftLeft","opacity","translate_speed","translate_speed_low","rotate_speed","rotate_speed_low","default_pose","position","rotation","Controls","model","setPose","ACTIONS","Object","fromEntries","entries","map","key","value","bind","this","keyDownListener","handleKeyDown","keyUpListener","handleKeyUp","executingActions","Set","Math","PI","document","addEventListener","removeEventListener","event","repeat","code","undefined","_decreaseSpeed","add","_resetSpeed","delete","quaternion","x","y","z","w","toArray","delta","action","rotateOnAxis","Vector3","Renderer","fov","initialPose","console","log","useThree","camera","gl","scene","controls","React","useMemo","useEffect","register","deregister","pose","up","set","lookAt","updateProjectionMatrix","slice","setRotationFromQuaternion","Quaternion","composer","useRef","useFrame","state","update","current","render","object","ref","args","attachArray","uniforms","tDiffuse","vertexShader","join","fragmentShader","extend","ShaderPass","RenderPass","EffectComposer","memo","style","intensity","OpenFileButton","props","children","label","others","type","display","className","Button","size","variant","onClick","click","TopBar","currentImageIndex","setCurrentImageIndex","images","setImages","setModel","setIntrinsics","currentPose","setPoses","poses","useState","intrinsicsName","setIntrinsicsName","modelName","setModelName","loader","GLTFLoader","n","toFixed","length","name","multiple","accept","onChange","target","files","file","arrayBuffer","then","ab","parse","gltf","scenes","loadModel","text","resultText","JSON","loadIntrinsics","loadPoses","obj","keys","a","createElement","Blob","stringify","href","URL","createObjectURL","download","revokeObjectURL","saveAs","Sidebar","ListGroup","Array","from","image","i","Item","active","computeViewerPosition","img","naturalHeight","naturalWidth","height","width","rescale","min","newHeight","newWidth","left","top","App","intrinsics","viewerPosition","setViewerPosition","setCurrentPose","imgRef","imgUrl","useCallback","window","assign","alt","src","onLoad","fov_y","ReactDOM","StrictMode","getElementById"],"mappings":"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","file":"static/js/main.d8d1b540.chunk.js","sourcesContent":["const CONFIG = {\n  keybindings: {\n    KeyW: \"translateUp\",\n    KeyS: \"translateDown\",\n    KeyA: \"translateLeft\",\n    KeyD: \"translateRight\",\n    KeyZ: \"translateForward\",\n    KeyX: \"translateBackward\",\n    ArrowDown: \"rotateMinusZ\",\n    ArrowUp: \"rotatePlusZ\",\n    ArrowLeft: \"rotateMinusY\",\n    ArrowRight: \"rotatePlusY\",\n    Slash: \"rotateMinusX\",\n    Period: \"rotatePlusX\",\n    ShiftLeft: \"decreaseSpeed\",\n  },\n  opacity: 0.7,\n  // meters/second\n  translate_speed: 5,\n  translate_speed_low: 1,\n  // degrees/second\n  rotate_speed: 20,\n  rotate_speed_low: 5,\n  default_pose: {\n    position: [0, 0, 50],\n    rotation: [1, 0, 0, 0],\n  },\n};\n\nexport default CONFIG;\n","import { Vector3 } from \"three\";\nimport CONFIG from \"./config\";\n\nexport default class Controls {\n  ACTIONS = Object.fromEntries(\n    Object.entries(CONFIG.keybindings).map(([key, value]) => [\n      key,\n      this[value] ? this[value].bind(this) : value,\n    ])\n  );\n\n  constructor(model, setPose) {\n    this.model = model;\n    this.keyDownListener = this.handleKeyDown.bind(this);\n    this.keyUpListener = this.handleKeyUp.bind(this);\n    this.executingActions = new Set();\n    this.translate_speed = CONFIG.translate_speed;\n    this.rotate_speed = (CONFIG.rotate_speed * 2 * Math.PI) / 180;\n    this.setPose = setPose;\n  }\n\n  register() {\n    document.addEventListener(\"keydown\", this.keyDownListener);\n    document.addEventListener(\"keyup\", this.keyUpListener);\n  }\n\n  deregister() {\n    document.removeEventListener(\"keydown\", this.keyDownListener);\n    document.removeEventListener(\"keyup\", this.keyUpListener);\n  }\n\n  handleKeyDown(event) {\n    if (event.repeat) return;\n    switch (this.ACTIONS[event.code]) {\n      case undefined:\n        break;\n      case \"decreaseSpeed\":\n        this._decreaseSpeed();\n        break;\n      default:\n        this.executingActions.add(this.ACTIONS[event.code]);\n    }\n  }\n\n  handleKeyUp(event) {\n    switch (this.ACTIONS[event.code]) {\n      case undefined:\n        break;\n      case \"decreaseSpeed\":\n        this._resetSpeed();\n        break;\n      default:\n        this.executingActions.delete(this.ACTIONS[event.code]);\n    }\n    const { x, y, z, w } = this.model.quaternion;\n    this.setPose({\n      position: this.model.position.toArray(),\n      rotation: [w, x, y, z],\n    });\n  }\n\n  update(delta) {\n    for (const action of this.executingActions) {\n      action(delta);\n    }\n  }\n\n  _decreaseSpeed() {\n    this.translate_speed = CONFIG.translate_speed_low;\n    this.rotate_speed = (CONFIG.rotate_speed_low * 2 * Math.PI) / 180;\n  }\n  _resetSpeed() {\n    this.translate_speed = CONFIG.translate_speed;\n    this.rotate_speed = (CONFIG.rotate_speed * 2 * Math.PI) / 180;\n  }\n\n  translateUp(delta) {\n    this.model.position.y -= this.translate_speed * delta;\n  }\n  translateDown(delta) {\n    this.model.position.y += this.translate_speed * delta;\n  }\n  translateLeft(delta) {\n    this.model.position.x -= this.translate_speed * delta;\n  }\n  translateRight(delta) {\n    this.model.position.x += this.translate_speed * delta;\n  }\n  translateForward(delta) {\n    this.model.position.z += this.translate_speed * delta;\n  }\n  translateBackward(delta) {\n    this.model.position.z -= this.translate_speed * delta;\n  }\n  rotatePlusZ(delta) {\n    this.model.rotateOnAxis(new Vector3(0, 0, 1), this.rotate_speed * delta);\n  }\n  rotateMinusZ(delta) {\n    this.model.rotateOnAxis(new Vector3(0, 0, 1), -this.rotate_speed * delta);\n  }\n  rotatePlusY(delta) {\n    this.model.rotateOnAxis(new Vector3(0, 1, 0), this.rotate_speed * delta);\n  }\n  rotateMinusY(delta) {\n    this.model.rotateOnAxis(new Vector3(0, 1, 0), -this.rotate_speed * delta);\n  }\n  rotatePlusX(delta) {\n    this.model.rotateOnAxis(new Vector3(1, 0, 0), this.rotate_speed * delta);\n  }\n  rotateMinusX(delta) {\n    this.model.rotateOnAxis(new Vector3(1, 0, 0), -this.rotate_speed * delta);\n  }\n}\n","import React from \"react\";\nimport { extend } from \"react-three-fiber\";\nimport { Canvas, useFrame, useThree } from \"react-three-fiber\";\nimport { Quaternion, Vector3 } from \"three\";\nimport { ShaderPass } from \"three/examples/jsm/postprocessing/ShaderPass\";\nimport { RenderPass } from \"three/examples/jsm/postprocessing/RenderPass\";\nimport { EffectComposer } from \"three/examples/jsm/postprocessing/EffectComposer\";\nimport Controls from \"./controls\";\nimport CONFIG from \"./config\";\nimport OpacityShader from \"./OpacityShader\";\nextend({ ShaderPass, RenderPass, EffectComposer });\n\nfunction Renderer({ model, fov, setPose, initialPose }) {\n  console.log(\"renderer re-render\");\n  const { camera, gl, scene } = useThree();\n\n  const controls = React.useMemo(() => new Controls(model, setPose), [\n    model,\n    setPose,\n  ]);\n  React.useEffect(() => {\n    controls.register();\n\n    return () => controls.deregister();\n  }, [controls]);\n\n  React.useEffect(() => {\n    camera.fov = fov;\n    camera.up = new Vector3(0, -1, 0);\n    camera.position.set(0, 0, 0);\n    camera.lookAt(0, 0, 100);\n    camera.updateProjectionMatrix();\n\n    let pose;\n    if (initialPose) {\n      pose = initialPose;\n    } else if (model.position.z === 0) {\n      pose = {\n        position: CONFIG.default_pose.position.slice(),\n        rotation: CONFIG.default_pose.rotation.slice(),\n      };\n    } else {\n      const { x, y, z, w } = model.quaternion;\n      pose = {\n        position: model.position.toArray(),\n        rotation: [w, x, y, z],\n      };\n    }\n    const [w, x, y, z] = pose.rotation;\n    model.position.set(...pose.position);\n    model.setRotationFromQuaternion(new Quaternion(x, y, z, w));\n    setPose(pose);\n  });\n\n  const composer = React.useRef();\n  useFrame((state, delta) => {\n    controls.update(delta);\n    composer.current.render();\n  }, 1);\n\n  return [\n    <primitive key=\"object\" object={model} />,\n    <effectComposer key=\"composer\" ref={composer} args={[gl]}>\n      <renderPass attachArray=\"passes\" scene={scene} camera={camera} />\n      <shaderPass attachArray=\"passes\" args={[OpacityShader(CONFIG.opacity)]} />\n    </effectComposer>,\n  ];\n}\n\nfunction Viewer({ model, fov, position, setPose, initialPose }) {\n  console.log(\"viewer re-render\");\n\n  return (\n    <Canvas style={{ position: \"absolute\", ...position }}>\n      <pointLight position={[0, 0, 0]} intensity={1} />\n      {model ? <Renderer {...{ model, fov, setPose, initialPose }} /> : null}\n    </Canvas>\n  );\n}\n\nexport default React.memo(Viewer);\n","/**\n * Full-screen textured quad shader\n */\n\nexport default function OpacityShader(opacity) {\n  return {\n    uniforms: {\n      tDiffuse: { value: null },\n      opacity: { value: opacity },\n    },\n\n    vertexShader: [\n      \"varying vec2 vUv;\",\n\n      \"void main() {\",\n\n      \"\tvUv = uv;\",\n      \"\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\",\n\n      \"}\",\n    ].join(\"\\n\"),\n\n    fragmentShader: [\n      \"uniform float opacity;\",\n\n      \"uniform sampler2D tDiffuse;\",\n\n      \"varying vec2 vUv;\",\n\n      \"void main() {\",\n\n      \"\tvec4 texel = texture2D( tDiffuse, vUv );\",\n      \"\tgl_FragColor = opacity * texel;\",\n\n      \"}\",\n    ].join(\"\\n\"),\n  };\n}\n","import React from \"react\";\nimport { Button } from \"react-bootstrap\";\nimport { GLTFLoader } from \"three/examples/jsm/loaders/GLTFLoader\";\n\nfunction saveAs(obj) {\n  if (Object.keys(obj).length === 0) {\n    return;\n  }\n  const a = document.createElement(\"a\");\n  const file = new Blob([JSON.stringify(obj)], { type: \"text/plain\" });\n  a.href = URL.createObjectURL(file);\n  a.download = \"poses.json\";\n  a.click();\n  URL.revokeObjectURL(a.href);\n}\n\nfunction loadModel(loader, file, setModel) {\n  file.arrayBuffer().then((ab) => {\n    loader.parse(ab, \"\", (gltf) => {\n      setModel(gltf.scenes[0].children[0]);\n    });\n  });\n}\n\nfunction loadIntrinsics(file, setIntrinsics) {\n  file.text().then((resultText) => setIntrinsics(JSON.parse(resultText)));\n}\n\nfunction loadPoses(file, setPoses) {\n  file.text().then((resultText) => setPoses(JSON.parse(resultText)));\n}\n\nfunction OpenFileButton(props) {\n  const ref = React.useRef();\n  const { children, label, ...others } = props;\n  return [\n    <input\n      key=\"input\"\n      type=\"file\"\n      ref={ref}\n      style={{ display: \"none\" }}\n      {...others}\n    />,\n    <div key=\"button\" className=\"OpenFileButton\">\n      <div className=\"OpenFileButton-label\">{label}</div>\n      <Button size=\"sm\" variant=\"light\" onClick={() => ref.current.click()}>\n        {children}\n      </Button>\n    </div>,\n  ];\n}\n\nexport default function TopBar({\n  currentImageIndex,\n  setCurrentImageIndex,\n  images,\n  setImages,\n  setModel,\n  setIntrinsics,\n  currentPose,\n  setPoses,\n  poses,\n}) {\n  const [intrinsicsName, setIntrinsicsName] = React.useState(\"\");\n  const [modelName, setModelName] = React.useState(\"\");\n  const loader = React.useMemo(() => new GLTFLoader(), []);\n  return (\n    <div className=\"StatusBar\">\n      {currentPose && currentPose.position && currentPose.rotation\n        ? [\n            <div key=\"pos\">{`position: (${currentPose.position.map((n) =>\n              n.toFixed(2)\n            )})`}</div>,\n            <div key=\"rot\">{`rotation: (${currentPose.rotation.map((n) =>\n              n.toFixed(2)\n            )})`}</div>,\n          ]\n        : null}\n      <div>{images.length > 0 ? images[currentImageIndex].name : null}</div>\n      <div>\n        <OpenFileButton\n          label={images.length ? `${images.length} images ` : null}\n          multiple\n          accept=\"image/*\"\n          onChange={(event) => {\n            if (event.target.files.length > 0) {\n              setCurrentImageIndex(0);\n              setImages(event.target.files);\n            }\n          }}\n        >\n          Load images\n        </OpenFileButton>\n      </div>\n      <div>\n        <OpenFileButton\n          label={modelName}\n          accept=\".glb\"\n          onChange={(event) => {\n            if (event.target.files.length > 0) {\n              setModelName(event.target.files[0].name);\n              loadModel(loader, event.target.files[0], setModel);\n            }\n          }}\n        >\n          Load model\n        </OpenFileButton>\n      </div>\n      <div>\n        <OpenFileButton\n          label={intrinsicsName}\n          accept=\".json\"\n          onChange={(event) => {\n            if (event.target.files.length > 0) {\n              setIntrinsicsName(event.target.files[0].name);\n              loadIntrinsics(event.target.files[0], setIntrinsics);\n            }\n          }}\n        >\n          Load intrinsics\n        </OpenFileButton>\n      </div>\n      <div>\n        <OpenFileButton\n          accept=\".json\"\n          onChange={(event) => {\n            if (event.target.files.length > 0) {\n              loadPoses(event.target.files[0], setPoses);\n            }\n          }}\n        >\n          Load poses\n        </OpenFileButton>\n      </div>\n      <div>\n        <Button size=\"sm\" variant=\"light\" onClick={() => saveAs(poses)}>\n          Save poses\n        </Button>\n      </div>\n    </div>\n  );\n}\n","import React from \"react\";\nimport { ListGroup } from \"react-bootstrap\";\n\nexport default function Sidebar({\n  images,\n  currentImageIndex,\n  setCurrentImageIndex,\n}) {\n  return (\n    <ListGroup variant=\"flush\" className=\"SideBar\">\n      {Array.from(images).map((image, i) => (\n        <ListGroup.Item\n          active={currentImageIndex === i}\n          key={i}\n          onClick={() => setCurrentImageIndex(i)}\n        >\n          {image.name}\n        </ListGroup.Item>\n      ))}\n    </ListGroup>\n  );\n}\n","import React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport \"./index.css\";\nimport Viewer from \"./viewer\";\nimport TopBar from \"./topbar\";\nimport Sidebar from \"./sidebar\";\n\nfunction computeViewerPosition(img) {\n  const { naturalHeight, naturalWidth, height, width } = img;\n  const rescale = Math.min(height / naturalHeight, width / naturalWidth);\n  const [newHeight, newWidth] = [\n    naturalHeight * rescale,\n    naturalWidth * rescale,\n  ];\n  return {\n    height: newHeight,\n    width: newWidth,\n    left: (width - newWidth) / 2,\n    top: (height - newHeight) / 2,\n  };\n}\n\nfunction App() {\n  console.log(\"index re-render\");\n\n  const [images, setImages] = React.useState([]);\n  const [intrinsics, setIntrinsics] = React.useState();\n  const [model, setModel] = React.useState();\n  const [currentImageIndex, setCurrentImageIndex] = React.useState();\n  const [viewerPosition, setViewerPosition] = React.useState();\n  const [poses, setPoses] = React.useState({});\n  const [currentPose, setCurrentPose] = React.useState({});\n\n  const imgRef = React.useRef();\n  const imgUrl = React.useMemo(\n    () =>\n      images.length > 0 ? URL.createObjectURL(images[currentImageIndex]) : null,\n    [images, currentImageIndex]\n  );\n\n  const handleKeyDown = React.useCallback(\n    (event) => {\n      if (images.length === 0 || event.repeat) return;\n      if (event.code === \"PageDown\")\n        setCurrentImageIndex((currentImageIndex + 1) % images.length);\n      if (event.code === \"PageUp\")\n        setCurrentImageIndex(\n          (currentImageIndex - 1 + images.length) % images.length // Javascript is a cruel joke\n        );\n    },\n    [images, currentImageIndex]\n  );\n  React.useEffect(() => {\n    document.addEventListener(\"keydown\", handleKeyDown);\n    return () => document.removeEventListener(\"keydown\", handleKeyDown);\n  }, [handleKeyDown]);\n\n  React.useEffect(() => {\n    window.addEventListener(\"resize\", () => {\n      if (imgRef.current)\n        setViewerPosition(computeViewerPosition(imgRef.current));\n    });\n  }, []);\n\n  const setPose = React.useCallback(\n    (pose) => {\n      if (poses[images[currentImageIndex].name]) {\n        // copy into the same reference so that the viewer doesn't re-render\n        Object.assign(poses[images[currentImageIndex].name], pose);\n      } else {\n        poses[images[currentImageIndex].name] = pose;\n      }\n      // do mutate the currentPose reference so that the topbar re-renders\n      setCurrentPose(pose);\n    },\n    [poses, images, currentImageIndex]\n  );\n\n  return (\n    <div className=\"main-wrapper\">\n      <TopBar\n        {...{\n          currentImageIndex,\n          setCurrentImageIndex,\n          images,\n          setImages,\n          model,\n          setModel,\n          setIntrinsics,\n          currentPose,\n          setPoses,\n          poses,\n        }}\n      />\n      <div className=\"body-wrapper\">\n        <div className=\"Viewer-wrapper\">\n          {images.length > 0\n            ? [\n                <img\n                  className=\"background-image\"\n                  alt=\"\"\n                  key=\"img\"\n                  ref={imgRef}\n                  src={imgUrl}\n                  onLoad={() => {\n                    setViewerPosition(computeViewerPosition(imgRef.current));\n                  }}\n                />,\n                <Viewer\n                  key=\"viewer\"\n                  {...{\n                    images,\n                    fov: intrinsics\n                      ? intrinsics[images[currentImageIndex].name].fov_y\n                      : 40,\n                    model,\n                    position: viewerPosition,\n                    initialPose: poses[images[currentImageIndex].name],\n                    setPose,\n                  }}\n                />,\n              ]\n            : null}\n        </div>\n        <Sidebar\n          {...{\n            images,\n            currentImageIndex,\n            setCurrentImageIndex,\n          }}\n        />\n      </div>\n    </div>\n  );\n}\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n);\n"],"sourceRoot":""}